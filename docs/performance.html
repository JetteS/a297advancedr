<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>Chapter 5 Performance | Advanced R Course</title>
  <meta name="description" content="This contains materials for the Advanced R course of the doctoral school of Grenoble, France." />
  <meta name="generator" content="bookdown 0.29 and GitBook 2.6.7" />

  <meta property="og:title" content="Chapter 5 Performance | Advanced R Course" />
  <meta property="og:type" content="book" />
  <meta property="og:image" content="https://privefl.github.io/advr38book//images/hexsticker.png" />
  <meta property="og:description" content="This contains materials for the Advanced R course of the doctoral school of Grenoble, France." />
  <meta name="github-repo" content="privefl/advr38book" />

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="Chapter 5 Performance | Advanced R Course" />
  <meta name="twitter:site" content="@privefl" />
  <meta name="twitter:description" content="This contains materials for the Advanced R course of the doctoral school of Grenoble, France." />
  <meta name="twitter:image" content="https://privefl.github.io/advr38book//images/hexsticker.png" />

<meta name="author" content="Florian Privé" />


<meta name="date" content="2023-08-18" />

  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="tidyverse.html"/>
<link rel="next" href="packages.html"/>
<script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fuse.js@6.4.6/dist/fuse.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />








<link href="libs/anchor-sections-1.1.0/anchor-sections.css" rel="stylesheet" />
<link href="libs/anchor-sections-1.1.0/anchor-sections-hash.css" rel="stylesheet" />
<script src="libs/anchor-sections-1.1.0/anchor-sections.js"></script>
<script src="libs/twitter-widget-0.0.1/widgets.js"></script>
<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-100463316-5"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-100463316-5');
</script>


<style type="text/css">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>


<link rel="stylesheet" href="style.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li><a href="./index.html">Advanced R Course</a></li>

<li class="divider"></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i>About</a>
<ul>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#license"><i class="fa fa-check"></i>License</a></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#author"><i class="fa fa-check"></i>Author</a></li>
</ul></li>
<li class="chapter" data-level="1" data-path="introduction.html"><a href="introduction.html"><i class="fa fa-check"></i><b>1</b> Introduction</a>
<ul>
<li class="chapter" data-level="1.1" data-path="introduction.html"><a href="introduction.html#prerequisites"><i class="fa fa-check"></i><b>1.1</b> Prerequisites</a></li>
<li class="chapter" data-level="1.2" data-path="introduction.html"><a href="introduction.html#content"><i class="fa fa-check"></i><b>1.2</b> Content</a></li>
<li class="chapter" data-level="1.3" data-path="introduction.html"><a href="introduction.html#useful-resources"><i class="fa fa-check"></i><b>1.3</b> Useful resources</a></li>
</ul></li>
<li class="chapter" data-level="2" data-path="good-practices.html"><a href="good-practices.html"><i class="fa fa-check"></i><b>2</b> Good practices</a>
<ul>
<li class="chapter" data-level="2.1" data-path="good-practices.html"><a href="good-practices.html#coding-style"><i class="fa fa-check"></i><b>2.1</b> Coding style</a>
<ul>
<li class="chapter" data-level="2.1.1" data-path="good-practices.html"><a href="good-practices.html#naming"><i class="fa fa-check"></i><b>2.1.1</b> Naming</a></li>
<li class="chapter" data-level="2.1.2" data-path="good-practices.html"><a href="good-practices.html#spacing"><i class="fa fa-check"></i><b>2.1.2</b> Spacing</a></li>
<li class="chapter" data-level="2.1.3" data-path="good-practices.html"><a href="good-practices.html#indenting"><i class="fa fa-check"></i><b>2.1.3</b> Indenting</a></li>
<li class="chapter" data-level="2.1.4" data-path="good-practices.html"><a href="good-practices.html#long-lines"><i class="fa fa-check"></i><b>2.1.4</b> Long lines</a></li>
<li class="chapter" data-level="2.1.5" data-path="good-practices.html"><a href="good-practices.html#other"><i class="fa fa-check"></i><b>2.1.5</b> Other</a></li>
</ul></li>
<li class="chapter" data-level="2.2" data-path="good-practices.html"><a href="good-practices.html#rstudio"><i class="fa fa-check"></i><b>2.2</b> RStudio</a></li>
<li class="chapter" data-level="2.3" data-path="good-practices.html"><a href="good-practices.html#git"><i class="fa fa-check"></i><b>2.3</b> Version control (Git)</a>
<ul>
<li class="chapter" data-level="2.3.1" data-path="good-practices.html"><a href="good-practices.html#why-use-git-you-dont-use-git"><i class="fa fa-check"></i><b>2.3.1</b> Why use Git? You don’t use Git?</a></li>
<li class="chapter" data-level="2.3.2" data-path="good-practices.html"><a href="good-practices.html#about-git"><i class="fa fa-check"></i><b>2.3.2</b> About Git</a></li>
</ul></li>
<li class="chapter" data-level="2.4" data-path="good-practices.html"><a href="good-practices.html#getting-help"><i class="fa fa-check"></i><b>2.4</b> Getting help</a>
<ul>
<li class="chapter" data-level="2.4.1" data-path="good-practices.html"><a href="good-practices.html#help-yourself-learn-how-to-debug"><i class="fa fa-check"></i><b>2.4.1</b> Help yourself, learn how to debug</a></li>
<li class="chapter" data-level="2.4.2" data-path="good-practices.html"><a href="good-practices.html#external-help"><i class="fa fa-check"></i><b>2.4.2</b> External help</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="3" data-path="r-programming.html"><a href="r-programming.html"><i class="fa fa-check"></i><b>3</b> R programming</a>
<ul>
<li class="chapter" data-level="3.1" data-path="r-programming.html"><a href="r-programming.html#common-mistakes"><i class="fa fa-check"></i><b>3.1</b> Common mistakes</a>
<ul>
<li class="chapter" data-level="3.1.1" data-path="r-programming.html"><a href="r-programming.html#equality"><i class="fa fa-check"></i><b>3.1.1</b> Equality</a></li>
<li class="chapter" data-level="3.1.2" data-path="r-programming.html"><a href="r-programming.html#arguments"><i class="fa fa-check"></i><b>3.1.2</b> Arguments</a></li>
<li class="chapter" data-level="3.1.3" data-path="r-programming.html"><a href="r-programming.html#others"><i class="fa fa-check"></i><b>3.1.3</b> Others</a></li>
</ul></li>
<li class="chapter" data-level="3.2" data-path="r-programming.html"><a href="r-programming.html#r-base-objects"><i class="fa fa-check"></i><b>3.2</b> R base objects</a>
<ul>
<li class="chapter" data-level="3.2.1" data-path="r-programming.html"><a href="r-programming.html#types"><i class="fa fa-check"></i><b>3.2.1</b> Types</a></li>
<li class="chapter" data-level="3.2.2" data-path="r-programming.html"><a href="r-programming.html#exercise"><i class="fa fa-check"></i><b>3.2.2</b> Exercise</a></li>
</ul></li>
<li class="chapter" data-level="3.3" data-path="r-programming.html"><a href="r-programming.html#base-objects-and-accessors"><i class="fa fa-check"></i><b>3.3</b> Base objects and accessors</a>
<ul>
<li class="chapter" data-level="3.3.1" data-path="r-programming.html"><a href="r-programming.html#objects"><i class="fa fa-check"></i><b>3.3.1</b> Objects</a></li>
<li class="chapter" data-level="3.3.2" data-path="r-programming.html"><a href="r-programming.html#accessors"><i class="fa fa-check"></i><b>3.3.2</b> Accessors</a></li>
<li class="chapter" data-level="3.3.3" data-path="r-programming.html"><a href="r-programming.html#exercises"><i class="fa fa-check"></i><b>3.3.3</b> Exercises</a></li>
</ul></li>
<li class="chapter" data-level="3.4" data-path="r-programming.html"><a href="r-programming.html#useful-r-base-functions"><i class="fa fa-check"></i><b>3.4</b> Useful R base functions</a>
<ul>
<li class="chapter" data-level="3.4.1" data-path="r-programming.html"><a href="r-programming.html#general"><i class="fa fa-check"></i><b>3.4.1</b> General</a></li>
<li class="chapter" data-level="3.4.2" data-path="r-programming.html"><a href="r-programming.html#sequence-and-vector-operations"><i class="fa fa-check"></i><b>3.4.2</b> Sequence and vector operations</a></li>
<li class="chapter" data-level="3.4.3" data-path="r-programming.html"><a href="r-programming.html#character-operations"><i class="fa fa-check"></i><b>3.4.3</b> Character operations</a></li>
<li class="chapter" data-level="3.4.4" data-path="r-programming.html"><a href="r-programming.html#logical-operators"><i class="fa fa-check"></i><b>3.4.4</b> Logical operators</a></li>
<li class="chapter" data-level="3.4.5" data-path="r-programming.html"><a href="r-programming.html#exercises-1"><i class="fa fa-check"></i><b>3.4.5</b> Exercises</a></li>
</ul></li>
<li class="chapter" data-level="3.5" data-path="r-programming.html"><a href="r-programming.html#environments-and-scoping"><i class="fa fa-check"></i><b>3.5</b> Environments and scoping</a></li>
<li class="chapter" data-level="3.6" data-path="r-programming.html"><a href="r-programming.html#attributes-and-classes"><i class="fa fa-check"></i><b>3.6</b> Attributes and classes</a></li>
</ul></li>
<li class="chapter" data-level="4" data-path="tidyverse.html"><a href="tidyverse.html"><i class="fa fa-check"></i><b>4</b> Data analysis with the tidyverse</a>
<ul>
<li class="chapter" data-level="4.1" data-path="tidyverse.html"><a href="tidyverse.html#program"><i class="fa fa-check"></i><b>4.1</b> Program</a></li>
<li class="chapter" data-level="4.2" data-path="tidyverse.html"><a href="tidyverse.html#other-chapters-from-this-book"><i class="fa fa-check"></i><b>4.2</b> Other chapters from this book</a></li>
<li class="chapter" data-level="4.3" data-path="tidyverse.html"><a href="tidyverse.html#other-resources"><i class="fa fa-check"></i><b>4.3</b> Other resources</a></li>
<li class="chapter" data-level="4.4" data-path="tidyverse.html"><a href="tidyverse.html#other-tidy-packages"><i class="fa fa-check"></i><b>4.4</b> Other “tidy” packages</a></li>
</ul></li>
<li class="chapter" data-level="5" data-path="performance.html"><a href="performance.html"><i class="fa fa-check"></i><b>5</b> Performance</a>
<ul>
<li class="chapter" data-level="5.1" data-path="performance.html"><a href="performance.html#rs-memory-management"><i class="fa fa-check"></i><b>5.1</b> R’s memory management</a>
<ul>
<li class="chapter" data-level="5.1.1" data-path="performance.html"><a href="performance.html#understanding-binding-basics"><i class="fa fa-check"></i><b>5.1.1</b> Understanding binding basics</a></li>
<li class="chapter" data-level="5.1.2" data-path="performance.html"><a href="performance.html#copy-on-modify"><i class="fa fa-check"></i><b>5.1.2</b> Copy-on-modify</a></li>
<li class="chapter" data-level="5.1.3" data-path="performance.html"><a href="performance.html#copy-on-modify-what-about-inside-functions"><i class="fa fa-check"></i><b>5.1.3</b> Copy-on-modify: what about inside functions?</a></li>
<li class="chapter" data-level="5.1.4" data-path="performance.html"><a href="performance.html#lists"><i class="fa fa-check"></i><b>5.1.4</b> Lists</a></li>
<li class="chapter" data-level="5.1.5" data-path="performance.html"><a href="performance.html#copy-on-modify-for-lists"><i class="fa fa-check"></i><b>5.1.5</b> Copy-on-modify for lists?</a></li>
<li class="chapter" data-level="5.1.6" data-path="performance.html"><a href="performance.html#data-frames"><i class="fa fa-check"></i><b>5.1.6</b> Data frames</a></li>
</ul></li>
<li class="chapter" data-level="5.2" data-path="performance.html"><a href="performance.html#early-advice"><i class="fa fa-check"></i><b>5.2</b> Early advice</a>
<ul>
<li class="chapter" data-level="5.2.1" data-path="performance.html"><a href="performance.html#never-grow-a-vector"><i class="fa fa-check"></i><b>5.2.1</b> NEVER GROW A VECTOR</a></li>
<li class="chapter" data-level="5.2.2" data-path="performance.html"><a href="performance.html#use-the-right-function"><i class="fa fa-check"></i><b>5.2.2</b> Use the right function</a></li>
<li class="chapter" data-level="5.2.3" data-path="performance.html"><a href="performance.html#do-not-try-to-optimize-everything"><i class="fa fa-check"></i><b>5.2.3</b> Do not try to optimize everything</a></li>
</ul></li>
<li class="chapter" data-level="5.3" data-path="performance.html"><a href="performance.html#vectorization"><i class="fa fa-check"></i><b>5.3</b> Vectorization</a>
<ul>
<li class="chapter" data-level="5.3.1" data-path="performance.html"><a href="performance.html#exercise-1"><i class="fa fa-check"></i><b>5.3.1</b> Exercise</a></li>
</ul></li>
<li class="chapter" data-level="5.4" data-path="performance.html"><a href="performance.html#Rcpp"><i class="fa fa-check"></i><b>5.4</b> Rcpp</a></li>
<li class="chapter" data-level="5.5" data-path="performance.html"><a href="performance.html#linear-algebra"><i class="fa fa-check"></i><b>5.5</b> Linear algebra</a>
<ul>
<li class="chapter" data-level="5.5.1" data-path="performance.html"><a href="performance.html#exercises-2"><i class="fa fa-check"></i><b>5.5.1</b> Exercises</a></li>
</ul></li>
<li class="chapter" data-level="5.6" data-path="performance.html"><a href="performance.html#algorithms-data-structures"><i class="fa fa-check"></i><b>5.6</b> Algorithms &amp; data structures</a></li>
<li class="chapter" data-level="5.7" data-path="performance.html"><a href="performance.html#exos"><i class="fa fa-check"></i><b>5.7</b> Exercises</a></li>
<li class="chapter" data-level="5.8" data-path="performance.html"><a href="performance.html#parallel-computing"><i class="fa fa-check"></i><b>5.8</b> Parallel computing</a></li>
</ul></li>
<li class="chapter" data-level="6" data-path="packages.html"><a href="packages.html"><i class="fa fa-check"></i><b>6</b> Packages</a>
<ul>
<li class="chapter" data-level="6.1" data-path="packages.html"><a href="packages.html#resources"><i class="fa fa-check"></i><b>6.1</b> Resources</a></li>
<li class="chapter" data-level="6.2" data-path="packages.html"><a href="packages.html#project-exercise"><i class="fa fa-check"></i><b>6.2</b> Project exercise</a></li>
<li class="chapter" data-level="6.3" data-path="packages.html"><a href="packages.html#pkg-start"><i class="fa fa-check"></i><b>6.3</b> Quick start</a></li>
<li class="chapter" data-level="6.4" data-path="packages.html"><a href="packages.html#pkg-basics"><i class="fa fa-check"></i><b>6.4</b> Basic stuff</a>
<ul>
<li class="chapter" data-level="6.4.1" data-path="packages.html"><a href="packages.html#description-file"><i class="fa fa-check"></i><b>6.4.1</b> <em>DESCRIPTION</em> file</a></li>
<li class="chapter" data-level="6.4.2" data-path="packages.html"><a href="packages.html#r-code"><i class="fa fa-check"></i><b>6.4.2</b> R code</a></li>
<li class="chapter" data-level="6.4.3" data-path="packages.html"><a href="packages.html#documentation"><i class="fa fa-check"></i><b>6.4.3</b> Documentation</a></li>
<li class="chapter" data-level="6.4.4" data-path="packages.html"><a href="packages.html#namespace-file"><i class="fa fa-check"></i><b>6.4.4</b> <em>NAMESPACE</em> file</a></li>
</ul></li>
<li class="chapter" data-level="6.5" data-path="packages.html"><a href="packages.html#good-practices-1"><i class="fa fa-check"></i><b>6.5</b> Good practices</a>
<ul>
<li class="chapter" data-level="6.5.1" data-path="packages.html"><a href="packages.html#pkg-tests"><i class="fa fa-check"></i><b>6.5.1</b> Testing</a></li>
<li class="chapter" data-level="6.5.2" data-path="packages.html"><a href="packages.html#pkg-ci"><i class="fa fa-check"></i><b>6.5.2</b> Continuous checking</a></li>
<li class="chapter" data-level="6.5.3" data-path="packages.html"><a href="packages.html#pkgdown"><i class="fa fa-check"></i><b>6.5.3</b> Pkgdown</a></li>
</ul></li>
<li class="chapter" data-level="6.6" data-path="packages.html"><a href="packages.html#more"><i class="fa fa-check"></i><b>6.6</b> More</a>
<ul>
<li class="chapter" data-level="6.6.1" data-path="packages.html"><a href="packages.html#rcpp"><i class="fa fa-check"></i><b>6.6.1</b> Rcpp</a></li>
<li class="chapter" data-level="6.6.2" data-path="packages.html"><a href="packages.html#ignore-files"><i class="fa fa-check"></i><b>6.6.2</b> Ignore files</a></li>
<li class="chapter" data-level="6.6.3" data-path="packages.html"><a href="packages.html#the-inst-directory"><i class="fa fa-check"></i><b>6.6.3</b> The <code>inst/</code> directory</a></li>
<li class="chapter" data-level="6.6.4" data-path="packages.html"><a href="packages.html#pkg-data"><i class="fa fa-check"></i><b>6.6.4</b> External data</a></li>
</ul></li>
<li class="chapter" data-level="6.7" data-path="packages.html"><a href="packages.html#release-on-cran"><i class="fa fa-check"></i><b>6.7</b> Release on CRAN</a></li>
</ul></li>
<li class="chapter" data-level="7" data-path="shiny.html"><a href="shiny.html"><i class="fa fa-check"></i><b>7</b> Shiny</a>
<ul>
<li class="chapter" data-level="7.1" data-path="shiny.html"><a href="shiny.html#example"><i class="fa fa-check"></i><b>7.1</b> Example</a></li>
<li class="chapter" data-level="7.2" data-path="shiny.html"><a href="shiny.html#datacamp-course"><i class="fa fa-check"></i><b>7.2</b> DataCamp course</a></li>
<li class="chapter" data-level="7.3" data-path="shiny.html"><a href="shiny.html#other-resources-1"><i class="fa fa-check"></i><b>7.3</b> Other resources</a></li>
</ul></li>
<li class="chapter" data-level="8" data-path="project.html"><a href="project.html"><i class="fa fa-check"></i><b>8</b> Project</a>
<ul>
<li class="chapter" data-level="8.1" data-path="project.html"><a href="project.html#what-is-tidy-tuesday"><i class="fa fa-check"></i><b>8.1</b> What is Tidy Tuesday?</a></li>
<li class="chapter" data-level="8.2" data-path="project.html"><a href="project.html#tidy-thursday"><i class="fa fa-check"></i><b>8.2</b> Tidy Thursday</a>
<ul>
<li class="chapter" data-level="8.2.1" data-path="project.html"><a href="project.html#choose-a-dataset"><i class="fa fa-check"></i><b>8.2.1</b> Choose a dataset</a></li>
<li class="chapter" data-level="8.2.2" data-path="project.html"><a href="project.html#visualize-the-data"><i class="fa fa-check"></i><b>8.2.2</b> Visualize the data</a></li>
<li class="chapter" data-level="8.2.3" data-path="project.html"><a href="project.html#compilation-of-tweets"><i class="fa fa-check"></i><b>8.2.3</b> Compilation of tweets</a></li>
<li class="chapter" data-level="8.2.4" data-path="project.html"><a href="project.html#example-1"><i class="fa fa-check"></i><b>8.2.4</b> Example</a></li>
<li class="chapter" data-level="8.2.5" data-path="project.html"><a href="project.html#presentation"><i class="fa fa-check"></i><b>8.2.5</b> Presentation</a></li>
</ul></li>
</ul></li>
<li class="divider"></li>
<li><a href="https://github.com/rstudio/bookdown" target="blank">Published with bookdown</a></li>
</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">Advanced R Course</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="performance" class="section level1 hasAnchor" number="5">
<h1><span class="header-section-number">Chapter 5</span> Performance<a href="performance.html#performance" class="anchor-section" aria-label="Anchor link to header"></a></h1>
<p>Some resources used here or for further reading:</p>
<ul>
<li><a href="https://adv-r.hadley.nz/perf-improve.html">Advanced R</a></li>
<li><a href="https://bookdown.org/csgillespie/efficientR/">Efficient R programming</a></li>
</ul>
<p>The people who say that “R is just always slow” are usually not great R programmers. It is true that writing inefficient R code is easy, yet writing efficient R code is also possible when you know what you’re doing.
In this chapter, you will learn how to write R(cpp) code that is fast.</p>
<!-- Some years ago, when introducing the Julia language, some really unfair benchmark comparisons were released (e.g. with loops where obvious and simpler vectorized code would have been much faster). I'm still mad at Julia for this and [I am not the only one](https://matloff.wordpress.com/2014/05/21/r-beats-python-r-beats-julia-anyone-else-wanna-challenge-r/). -->
<div id="rs-memory-management" class="section level2 hasAnchor" number="5.1">
<h2><span class="header-section-number">5.1</span> R’s memory management<a href="performance.html#rs-memory-management" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>Read more with <a href="https://adv-r.hadley.nz/names-values.html">this chapter of Advanced R</a>.</p>
<div id="understanding-binding-basics" class="section level3 hasAnchor" number="5.1.1">
<h3><span class="header-section-number">5.1.1</span> Understanding binding basics<a href="performance.html#understanding-binding-basics" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<div class="sourceCode" id="cb346"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb346-1"><a href="performance.html#cb346-1" tabindex="-1"></a>x <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">3</span>)</span></code></pre></div>
<ul>
<li>It’s creating an object, a vector of values, <code>c(1, 2, 3)</code>.</li>
<li>And it’s binding that object to a name, <code>x</code>.</li>
</ul>
<p><img src="https://d33wubrfki0l68.cloudfront.net/bd90c87ac98708b1731c92900f2f53ec6a71edaf/ce375/diagrams/name-value/binding-1.png" width="32%" style="display: block; margin: auto;" /></p>
<p><br></p>
<div class="sourceCode" id="cb347"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb347-1"><a href="performance.html#cb347-1" tabindex="-1"></a>y <span class="ot">&lt;-</span> x</span></code></pre></div>
<p><img src="https://d33wubrfki0l68.cloudfront.net/bdc72c04d3135f19fb3ab13731129eb84c9170af/f0ab9/diagrams/name-value/binding-2.png" width="30%" style="display: block; margin: auto;" /></p>
<p>There are now two names for the same object in memory.</p>
</div>
<div id="copy-on-modify" class="section level3 hasAnchor" number="5.1.2">
<h3><span class="header-section-number">5.1.2</span> Copy-on-modify<a href="performance.html#copy-on-modify" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<div class="sourceCode" id="cb348"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb348-1"><a href="performance.html#cb348-1" tabindex="-1"></a>x <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">3</span>)</span>
<span id="cb348-2"><a href="performance.html#cb348-2" tabindex="-1"></a>y <span class="ot">&lt;-</span> x</span>
<span id="cb348-3"><a href="performance.html#cb348-3" tabindex="-1"></a>y[<span class="dv">3</span>] <span class="ot">&lt;-</span> <span class="dv">4</span></span></code></pre></div>
<div class="sourceCode" id="cb349"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb349-1"><a href="performance.html#cb349-1" tabindex="-1"></a>x</span></code></pre></div>
<pre><code>#&gt; [1] 1 2 3</code></pre>
<p><img src="https://d33wubrfki0l68.cloudfront.net/ef9f480effa2f1d0e401d1f94218d0cf118433c0/b56e9/diagrams/name-value/binding-3.png" width="28%" style="display: block; margin: auto;" /></p>
<p>The object in memory is copied before being modified, so that <code>x</code> is not modified.</p>
</div>
<div id="copy-on-modify-what-about-inside-functions" class="section level3 hasAnchor" number="5.1.3">
<h3><span class="header-section-number">5.1.3</span> Copy-on-modify: what about inside functions?<a href="performance.html#copy-on-modify-what-about-inside-functions" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<div class="sourceCode" id="cb351"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb351-1"><a href="performance.html#cb351-1" tabindex="-1"></a>f <span class="ot">&lt;-</span> <span class="cf">function</span>(a) {</span>
<span id="cb351-2"><a href="performance.html#cb351-2" tabindex="-1"></a>  a</span>
<span id="cb351-3"><a href="performance.html#cb351-3" tabindex="-1"></a>}</span>
<span id="cb351-4"><a href="performance.html#cb351-4" tabindex="-1"></a>x <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">3</span>)</span>
<span id="cb351-5"><a href="performance.html#cb351-5" tabindex="-1"></a>z <span class="ot">&lt;-</span> <span class="fu">f</span>(x)</span></code></pre></div>
<p><img src="https://d33wubrfki0l68.cloudfront.net/e8718027aabaed377da311f45b45a179588e4dcf/6bf90/diagrams/name-value/binding-f2.png" width="30%" style="display: block; margin: auto;" /></p>
<div class="sourceCode" id="cb352"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb352-1"><a href="performance.html#cb352-1" tabindex="-1"></a>f2 <span class="ot">&lt;-</span> <span class="cf">function</span>(a) {</span>
<span id="cb352-2"><a href="performance.html#cb352-2" tabindex="-1"></a>  a[<span class="dv">1</span>] <span class="ot">&lt;-</span> <span class="dv">10</span></span>
<span id="cb352-3"><a href="performance.html#cb352-3" tabindex="-1"></a>  a</span>
<span id="cb352-4"><a href="performance.html#cb352-4" tabindex="-1"></a>}</span>
<span id="cb352-5"><a href="performance.html#cb352-5" tabindex="-1"></a>z2 <span class="ot">&lt;-</span> <span class="fu">f2</span>(x)</span></code></pre></div>
<div class="sourceCode" id="cb353"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb353-1"><a href="performance.html#cb353-1" tabindex="-1"></a><span class="fu">cbind</span>(x, z2)</span></code></pre></div>
<pre><code>#&gt;      x z2
#&gt; [1,] 1 10
#&gt; [2,] 2  2
#&gt; [3,] 3  3</code></pre>
<p>The input parameter is not modified; you operate on a local copy of <code>a = x</code> in <code>f2()</code>.</p>
</div>
<div id="lists" class="section level3 hasAnchor" number="5.1.4">
<h3><span class="header-section-number">5.1.4</span> Lists<a href="performance.html#lists" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>It’s not just names (i.e. variables) that point to values; elements of lists do too.</p>
<div class="sourceCode" id="cb355"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb355-1"><a href="performance.html#cb355-1" tabindex="-1"></a>l1 <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">3</span>)</span></code></pre></div>
<p><img src="https://d33wubrfki0l68.cloudfront.net/dae84980f1586fc4ef47091c91f51a5737b38135/a1403/diagrams/name-value/list.png" width="32%" style="display: block; margin: auto;" /></p>
<div class="sourceCode" id="cb356"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb356-1"><a href="performance.html#cb356-1" tabindex="-1"></a>l2 <span class="ot">&lt;-</span> l1</span></code></pre></div>
<p><img src="https://d33wubrfki0l68.cloudfront.net/52bc0e3da3382cba957a9d83397b6c9200906ce2/c72aa/diagrams/name-value/l-modify-1.png" width="30%" style="display: block; margin: auto;" /></p>
</div>
<div id="copy-on-modify-for-lists" class="section level3 hasAnchor" number="5.1.5">
<h3><span class="header-section-number">5.1.5</span> Copy-on-modify for lists?<a href="performance.html#copy-on-modify-for-lists" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<div class="sourceCode" id="cb357"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb357-1"><a href="performance.html#cb357-1" tabindex="-1"></a>l2[[<span class="dv">3</span>]] <span class="ot">&lt;-</span> <span class="dv">4</span></span></code></pre></div>
<p><img src="https://d33wubrfki0l68.cloudfront.net/b844bb5a3443e1344299627f5760e2ae3a9885b5/e1c76/diagrams/name-value/l-modify-2.png" width="38%" style="display: block; margin: auto;" /></p>
<p>Only the third element needs to be copied.</p>
</div>
<div id="data-frames" class="section level3 hasAnchor" number="5.1.6">
<h3><span class="header-section-number">5.1.6</span> Data frames<a href="performance.html#data-frames" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p><strong>Data frames are lists of vectors.</strong></p>
<div class="sourceCode" id="cb358"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb358-1"><a href="performance.html#cb358-1" tabindex="-1"></a>d1 <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">x =</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">5</span>, <span class="dv">6</span>), <span class="at">y =</span> <span class="fu">c</span>(<span class="dv">2</span>, <span class="dv">4</span>, <span class="dv">3</span>))</span></code></pre></div>
<p><img src="https://d33wubrfki0l68.cloudfront.net/80d8995999aa240ff4bc91bb6aba2c7bf72afc24/95ee6/diagrams/name-value/dataframe.png" width="28%" style="display: block; margin: auto;" /></p>
<div class="sourceCode" id="cb359"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb359-1"><a href="performance.html#cb359-1" tabindex="-1"></a>d2 <span class="ot">&lt;-</span> d1</span>
<span id="cb359-2"><a href="performance.html#cb359-2" tabindex="-1"></a>d2[, <span class="dv">2</span>] <span class="ot">&lt;-</span> d2[, <span class="dv">2</span>] <span class="sc">*</span> <span class="dv">2</span>  <span class="co"># modify one column</span></span></code></pre></div>
<p><img src="https://d33wubrfki0l68.cloudfront.net/c19fd7e31bf34ceff73d0fac6e3ea22b09429e4a/23d8d/diagrams/name-value/d-modify-c.png" width="30%" style="display: block; margin: auto;" /></p>
<div class="sourceCode" id="cb360"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb360-1"><a href="performance.html#cb360-1" tabindex="-1"></a>d3 <span class="ot">&lt;-</span> d1</span>
<span id="cb360-2"><a href="performance.html#cb360-2" tabindex="-1"></a>d3[<span class="dv">1</span>, ] <span class="ot">&lt;-</span> d3[<span class="dv">1</span>, ] <span class="sc">*</span> <span class="dv">3</span>  <span class="co"># modify one row</span></span></code></pre></div>
<p><img src="https://d33wubrfki0l68.cloudfront.net/36df61f54d1ac62e066fb814cb7ba38ea6047a74/facf8/diagrams/name-value/d-modify-r.png" width="45%" style="display: block; margin: auto;" /></p>
<p>By modifying the first row, you’re modifying the first element of all vectors, therefore the full data frame is copied..</p>
</div>
</div>
<div id="early-advice" class="section level2 hasAnchor" number="5.2">
<h2><span class="header-section-number">5.2</span> Early advice<a href="performance.html#early-advice" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<div id="never-grow-a-vector" class="section level3 hasAnchor" number="5.2.1">
<h3><span class="header-section-number">5.2.1</span> NEVER GROW A VECTOR<a href="performance.html#never-grow-a-vector" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>Example computing the cumulative sums of a vector:</p>
<div class="sourceCode" id="cb361"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb361-1"><a href="performance.html#cb361-1" tabindex="-1"></a>x <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(<span class="fl">2e4</span>)  <span class="co"># Try also with n = 1e5</span></span>
<span id="cb361-2"><a href="performance.html#cb361-2" tabindex="-1"></a><span class="fu">system.time</span>({</span>
<span id="cb361-3"><a href="performance.html#cb361-3" tabindex="-1"></a>  current_sum <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb361-4"><a href="performance.html#cb361-4" tabindex="-1"></a>  res <span class="ot">&lt;-</span> <span class="fu">c</span>()</span>
<span id="cb361-5"><a href="performance.html#cb361-5" tabindex="-1"></a>  <span class="cf">for</span> (x_i <span class="cf">in</span> x) {</span>
<span id="cb361-6"><a href="performance.html#cb361-6" tabindex="-1"></a>    current_sum <span class="ot">&lt;-</span> current_sum <span class="sc">+</span> x_i</span>
<span id="cb361-7"><a href="performance.html#cb361-7" tabindex="-1"></a>    res <span class="ot">&lt;-</span> <span class="fu">c</span>(res, current_sum)</span>
<span id="cb361-8"><a href="performance.html#cb361-8" tabindex="-1"></a>  }</span>
<span id="cb361-9"><a href="performance.html#cb361-9" tabindex="-1"></a>})</span></code></pre></div>
<pre><code>#&gt;    user  system elapsed 
#&gt;    0.52    0.37    0.91</code></pre>
<p>Here, at each iteration, you are reallocating a vector (of increasing size). Not only computations take time, memory allocations do too. This makes your code quadratic with the size of <code>x</code> (if you multiply the size of <code>x</code> by 2, you can expect the execution time to be multiplied by 4, for large sample sizes), whereas it should be only linear.</p>
<p>What happens is similar to if you would like to climb these stairs, you climb one stair, go to the bottom, then climb two stairs, go to bottom, climb three, and so on. That takes way more time than just climbing all stairs at once.</p>
<p><img src="https://privefl.github.io/blog/images/stairs.jpg" width="50%" style="display: block; margin: auto;" /></p>
<p>A good solution is to always pre-allocate your results (if you know the size):</p>
<div class="sourceCode" id="cb363"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb363-1"><a href="performance.html#cb363-1" tabindex="-1"></a><span class="fu">system.time</span>({</span>
<span id="cb363-2"><a href="performance.html#cb363-2" tabindex="-1"></a>  current_sum <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb363-3"><a href="performance.html#cb363-3" tabindex="-1"></a>  res2 <span class="ot">&lt;-</span> <span class="fu">double</span>(<span class="fu">length</span>(x))</span>
<span id="cb363-4"><a href="performance.html#cb363-4" tabindex="-1"></a>  <span class="cf">for</span> (i <span class="cf">in</span> <span class="fu">seq_along</span>(x)) {</span>
<span id="cb363-5"><a href="performance.html#cb363-5" tabindex="-1"></a>    current_sum <span class="ot">&lt;-</span> current_sum <span class="sc">+</span> x[i]</span>
<span id="cb363-6"><a href="performance.html#cb363-6" tabindex="-1"></a>    res2[i] <span class="ot">&lt;-</span> current_sum</span>
<span id="cb363-7"><a href="performance.html#cb363-7" tabindex="-1"></a>  }</span>
<span id="cb363-8"><a href="performance.html#cb363-8" tabindex="-1"></a>})</span></code></pre></div>
<pre><code>#&gt;    user  system elapsed 
#&gt;       0       0       0</code></pre>
<div class="sourceCode" id="cb365"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb365-1"><a href="performance.html#cb365-1" tabindex="-1"></a><span class="fu">all.equal</span>(res2, res)</span></code></pre></div>
<pre><code>#&gt; [1] TRUE</code></pre>
<p>If you don’t know the size of the results, you can store them in a list and merge them afterwards:</p>
<div class="sourceCode" id="cb367"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb367-1"><a href="performance.html#cb367-1" tabindex="-1"></a><span class="fu">system.time</span>({</span>
<span id="cb367-2"><a href="performance.html#cb367-2" tabindex="-1"></a>  current_sum <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb367-3"><a href="performance.html#cb367-3" tabindex="-1"></a>  res3 <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb367-4"><a href="performance.html#cb367-4" tabindex="-1"></a>  <span class="cf">for</span> (i <span class="cf">in</span> <span class="fu">seq_along</span>(x)) {</span>
<span id="cb367-5"><a href="performance.html#cb367-5" tabindex="-1"></a>    current_sum <span class="ot">&lt;-</span> current_sum <span class="sc">+</span> x[i]</span>
<span id="cb367-6"><a href="performance.html#cb367-6" tabindex="-1"></a>    res3[[i]] <span class="ot">&lt;-</span> current_sum</span>
<span id="cb367-7"><a href="performance.html#cb367-7" tabindex="-1"></a>  }</span>
<span id="cb367-8"><a href="performance.html#cb367-8" tabindex="-1"></a>})</span></code></pre></div>
<pre><code>#&gt;    user  system elapsed 
#&gt;    0.02    0.00    0.01</code></pre>
<div class="sourceCode" id="cb369"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb369-1"><a href="performance.html#cb369-1" tabindex="-1"></a><span class="fu">all.equal</span>(<span class="fu">unlist</span>(res3), res)</span></code></pre></div>
<pre><code>#&gt; [1] TRUE</code></pre>
<p>With recent versions of R (&gt;= 3.4), you can efficiently grow a vector using</p>
<div class="sourceCode" id="cb371"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb371-1"><a href="performance.html#cb371-1" tabindex="-1"></a><span class="fu">system.time</span>({</span>
<span id="cb371-2"><a href="performance.html#cb371-2" tabindex="-1"></a>  current_sum <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb371-3"><a href="performance.html#cb371-3" tabindex="-1"></a>  res4 <span class="ot">&lt;-</span> <span class="fu">c</span>()</span>
<span id="cb371-4"><a href="performance.html#cb371-4" tabindex="-1"></a>  <span class="cf">for</span> (i <span class="cf">in</span> <span class="fu">seq_along</span>(x)) {</span>
<span id="cb371-5"><a href="performance.html#cb371-5" tabindex="-1"></a>    current_sum <span class="ot">&lt;-</span> current_sum <span class="sc">+</span> x[i]</span>
<span id="cb371-6"><a href="performance.html#cb371-6" tabindex="-1"></a>    res4[i] <span class="ot">&lt;-</span> current_sum</span>
<span id="cb371-7"><a href="performance.html#cb371-7" tabindex="-1"></a>  }</span>
<span id="cb371-8"><a href="performance.html#cb371-8" tabindex="-1"></a>})</span></code></pre></div>
<pre><code>#&gt;    user  system elapsed 
#&gt;       0       0       0</code></pre>
<div class="sourceCode" id="cb373"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb373-1"><a href="performance.html#cb373-1" tabindex="-1"></a><span class="fu">all.equal</span>(res4, res)</span></code></pre></div>
<pre><code>#&gt; [1] TRUE</code></pre>
<blockquote>
<p>Assigning to an element of a vector beyond the current length now over-allocates by a small fraction. The new vector is marked internally as growable, and the true length of the new vector is stored in the truelength field. This makes building up a vector result by assigning to the next element beyond the current length more efficient, though pre-allocating is still preferred. The implementation is subject to change and not intended to be used in packages at this time. (<a href="https://cran.r-project.org/doc/manuals/r-release/NEWS.html">NEWS</a>)</p>
</blockquote>
<p>An even better solution would be to avoid the loop by using a vectorized function:</p>
<div class="sourceCode" id="cb375"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb375-1"><a href="performance.html#cb375-1" tabindex="-1"></a><span class="fu">system.time</span>(res5 <span class="ot">&lt;-</span> <span class="fu">cumsum</span>(x))</span></code></pre></div>
<pre><code>#&gt;    user  system elapsed 
#&gt;       0       0       0</code></pre>
<div class="sourceCode" id="cb377"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb377-1"><a href="performance.html#cb377-1" tabindex="-1"></a><span class="fu">all.equal</span>(res5, res)</span></code></pre></div>
<pre><code>#&gt; [1] TRUE</code></pre>
<div class="sourceCode" id="cb379"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb379-1"><a href="performance.html#cb379-1" tabindex="-1"></a>x <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(<span class="fl">1e7</span>)</span>
<span id="cb379-2"><a href="performance.html#cb379-2" tabindex="-1"></a><span class="fu">system.time</span>(<span class="fu">cumsum</span>(x))</span></code></pre></div>
<pre><code>#&gt;    user  system elapsed 
#&gt;    0.08    0.00    0.08</code></pre>
<hr />
<p>As a second example, let us generate a matrix of uniform values (max changing for every column):</p>
<div class="sourceCode" id="cb381"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb381-1"><a href="performance.html#cb381-1" tabindex="-1"></a>n <span class="ot">&lt;-</span> <span class="fl">1e3</span></span>
<span id="cb381-2"><a href="performance.html#cb381-2" tabindex="-1"></a>max <span class="ot">&lt;-</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">1000</span></span>
<span id="cb381-3"><a href="performance.html#cb381-3" tabindex="-1"></a><span class="fu">system.time</span>({</span>
<span id="cb381-4"><a href="performance.html#cb381-4" tabindex="-1"></a>  mat <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb381-5"><a href="performance.html#cb381-5" tabindex="-1"></a>  <span class="cf">for</span> (m <span class="cf">in</span> max) {</span>
<span id="cb381-6"><a href="performance.html#cb381-6" tabindex="-1"></a>    mat <span class="ot">&lt;-</span> <span class="fu">cbind</span>(mat, <span class="fu">runif</span>(n, <span class="at">max =</span> m))</span>
<span id="cb381-7"><a href="performance.html#cb381-7" tabindex="-1"></a>  }</span>
<span id="cb381-8"><a href="performance.html#cb381-8" tabindex="-1"></a>})</span></code></pre></div>
<pre><code>#&gt;    user  system elapsed 
#&gt;    0.67    0.55    1.25</code></pre>
<div class="sourceCode" id="cb383"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb383-1"><a href="performance.html#cb383-1" tabindex="-1"></a><span class="fu">apply</span>(mat, <span class="dv">2</span>, max)[<span class="dv">1</span><span class="sc">:</span><span class="dv">10</span>]</span></code></pre></div>
<pre><code>#&gt;  [1] 0.9995517 1.9990569 2.9973087 3.9971285 4.9972705 5.9993567 6.9910700 7.9720831
#&gt;  [9] 8.9855022 9.9890691</code></pre>
<p>Instead, we should pre-allocate a matrix of the right size:</p>
<div class="sourceCode" id="cb385"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb385-1"><a href="performance.html#cb385-1" tabindex="-1"></a><span class="fu">system.time</span>({</span>
<span id="cb385-2"><a href="performance.html#cb385-2" tabindex="-1"></a>  mat3 <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="dv">0</span>, n, <span class="fu">length</span>(max))</span>
<span id="cb385-3"><a href="performance.html#cb385-3" tabindex="-1"></a>  <span class="cf">for</span> (i <span class="cf">in</span> <span class="fu">seq_along</span>(max)) {</span>
<span id="cb385-4"><a href="performance.html#cb385-4" tabindex="-1"></a>    mat3[, i] <span class="ot">&lt;-</span> <span class="fu">runif</span>(n, <span class="at">max =</span> max[i])</span>
<span id="cb385-5"><a href="performance.html#cb385-5" tabindex="-1"></a>  }</span>
<span id="cb385-6"><a href="performance.html#cb385-6" tabindex="-1"></a>})</span></code></pre></div>
<pre><code>#&gt;    user  system elapsed 
#&gt;    0.05    0.00    0.05</code></pre>
<div class="sourceCode" id="cb387"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb387-1"><a href="performance.html#cb387-1" tabindex="-1"></a><span class="fu">apply</span>(mat3, <span class="dv">2</span>, max)[<span class="dv">1</span><span class="sc">:</span><span class="dv">10</span>]</span></code></pre></div>
<pre><code>#&gt;  [1] 0.9998887 1.9966502 2.9944519 3.9954697 4.9952371 5.9965820 6.9898207 7.9840037
#&gt;  [9] 8.9945157 9.9982988</code></pre>
<p>Or we could use a list instead. What is nice with using a list is that you don’t need to pre-allocate. Indeed, as opposed to atomic vectors, each element of a list is in different places in memory so that you don’t have to reallocate all the data when you add an element to a list.</p>
<div class="sourceCode" id="cb389"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb389-1"><a href="performance.html#cb389-1" tabindex="-1"></a><span class="fu">system.time</span>({</span>
<span id="cb389-2"><a href="performance.html#cb389-2" tabindex="-1"></a>  l <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb389-3"><a href="performance.html#cb389-3" tabindex="-1"></a>  <span class="cf">for</span> (i <span class="cf">in</span> <span class="fu">seq_along</span>(max)) {</span>
<span id="cb389-4"><a href="performance.html#cb389-4" tabindex="-1"></a>    l[[i]] <span class="ot">&lt;-</span> <span class="fu">runif</span>(n, <span class="at">max =</span> max[i])</span>
<span id="cb389-5"><a href="performance.html#cb389-5" tabindex="-1"></a>  }</span>
<span id="cb389-6"><a href="performance.html#cb389-6" tabindex="-1"></a>  mat4 <span class="ot">&lt;-</span> <span class="fu">do.call</span>(<span class="st">&quot;cbind&quot;</span>, l)</span>
<span id="cb389-7"><a href="performance.html#cb389-7" tabindex="-1"></a>})</span></code></pre></div>
<pre><code>#&gt;    user  system elapsed 
#&gt;    0.05    0.00    0.05</code></pre>
<div class="sourceCode" id="cb391"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb391-1"><a href="performance.html#cb391-1" tabindex="-1"></a><span class="fu">apply</span>(mat4, <span class="dv">2</span>, max)[<span class="dv">1</span><span class="sc">:</span><span class="dv">10</span>]</span></code></pre></div>
<pre><code>#&gt;  [1] 0.9997514 1.9981741 2.9956951 3.9999324 4.9978970 5.9978088 6.9935050 7.9913796
#&gt;  [9] 8.9941795 9.9920729</code></pre>
<p>Instead of pre-allocating yourself, you can use <code>sapply</code> (or <code>lapply</code> and calling <code>do.call()</code> after, as previously done):</p>
<div class="sourceCode" id="cb393"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb393-1"><a href="performance.html#cb393-1" tabindex="-1"></a><span class="fu">system.time</span>(</span>
<span id="cb393-2"><a href="performance.html#cb393-2" tabindex="-1"></a>  mat4 <span class="ot">&lt;-</span> <span class="fu">sapply</span>(max, <span class="cf">function</span>(m) <span class="fu">runif</span>(n, <span class="at">max =</span> m))</span>
<span id="cb393-3"><a href="performance.html#cb393-3" tabindex="-1"></a>)</span></code></pre></div>
<pre><code>#&gt;    user  system elapsed 
#&gt;    0.03    0.00    0.03</code></pre>
<div class="sourceCode" id="cb395"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb395-1"><a href="performance.html#cb395-1" tabindex="-1"></a><span class="fu">apply</span>(mat4, <span class="dv">2</span>, max)[<span class="dv">1</span><span class="sc">:</span><span class="dv">10</span>]</span></code></pre></div>
<pre><code>#&gt;  [1] 0.9981629 1.9998850 2.9979426 3.9997915 4.9958974 5.9943567 6.9984283 7.9892951
#&gt;  [9] 8.9946816 9.9940610</code></pre>
<p>Don’t listen to people telling you that <code>sapply()</code> is a vectorized operation that is so much faster than loops. That’s false, and for-loops can actually be much faster than <code>sapply()</code> when using just-in-time (JIT) compilation. You can learn more with <a href="https://privefl.github.io/blog/why-loops-are-slow-in-r/">this blog post</a>.</p>
<!-- ### Access columns of a matrix -->
<!-- When you do computations on a matrix, recall that a matrix is just a vector with some dimensions. -->
<!-- ```{r} -->
<!-- vec <- 1:20 -->
<!-- dim(vec) <- c(4, 5) -->
<!-- vec -->
<!-- ``` -->
<!-- So, as you can see in this example, R matrices are column-oriented, which means that elements of the same column are stored contiguously in memory. Therefore, accessing elements of the same column is fast.  -->
</div>
<div id="use-the-right-function" class="section level3 hasAnchor" number="5.2.2">
<h3><span class="header-section-number">5.2.2</span> Use the right function<a href="performance.html#use-the-right-function" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>Often, in order to optimize your code, you can simply find the right function to do what you need to do.</p>
<p>For example, <code>rowMeans(x)</code> is much faster than <code>apply(x, 1, mean)</code>.
Similarly, if you want more efficient functions that apply to rows and columns of matrices, you can check <a href="https://github.com/HenrikBengtsson/matrixStats">package {matrixStats}</a>.</p>
<p>Another example is when reading large text files; in such cases, prefer using <code>data.table::fread()</code> rather than <code>read.table()</code>.</p>
<p>Generally, packages that uses C/Rcpp are efficient.</p>
</div>
<div id="do-not-try-to-optimize-everything" class="section level3 hasAnchor" number="5.2.3">
<h3><span class="header-section-number">5.2.3</span> Do not try to optimize everything<a href="performance.html#do-not-try-to-optimize-everything" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<blockquote>
<p>“Programmers waste enormous amounts of time thinking about, or worrying
about, the speed of noncritical parts of their programs, and these attempts
at efficiency actually have a strong negative impact when debugging and
maintenance are considered.”</p>
<p>— Donald Knuth.</p>
</blockquote>
<p>If you try to optimize each and every part of your code, you will end up losing a lot of time writing it, and it will probably make your code less readable.</p>
<p>R is great at prototyping quickly because you can write code in a concise and easy way. Start by doing just that. If performance matters, then profile your code to see which part of your code is taking too much time and optimize only this part!</p>
<p>Learn more on how to profile your code in RStudio in <a href="https://support.posit.co/hc/en-us/articles/218221837-Profiling-R-code-with-the-RStudio-IDE">this article</a>.</p>
</div>
</div>
<div id="vectorization" class="section level2 hasAnchor" number="5.3">
<h2><span class="header-section-number">5.3</span> Vectorization<a href="performance.html#vectorization" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>I call <em>vectorized</em> a function that takes vectors as arguments and operate on each element of these vectors in another (compiled) language (such as C, C++ and Fortran). Again, <code>sapply()</code> is not a vectorized function (cf. above).</p>
<p>Take this code:</p>
<div class="sourceCode" id="cb397"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb397-1"><a href="performance.html#cb397-1" tabindex="-1"></a>N <span class="ot">&lt;-</span> <span class="fl">10e3</span>; x <span class="ot">&lt;-</span> <span class="fu">runif</span>(N); y <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(N)</span>
<span id="cb397-2"><a href="performance.html#cb397-2" tabindex="-1"></a></span>
<span id="cb397-3"><a href="performance.html#cb397-3" tabindex="-1"></a>res <span class="ot">&lt;-</span> <span class="fu">double</span>(<span class="fu">length</span>(x))</span>
<span id="cb397-4"><a href="performance.html#cb397-4" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="fu">seq_along</span>(x)) {</span>
<span id="cb397-5"><a href="performance.html#cb397-5" tabindex="-1"></a>  res[i] <span class="ot">&lt;-</span> x[i] <span class="sc">+</span> y[i]</span>
<span id="cb397-6"><a href="performance.html#cb397-6" tabindex="-1"></a>}</span></code></pre></div>
<p>As an interpreted language, for each iteration <code>res[i] &lt;- x[i] + y[i]</code>, R has to ask:</p>
<ul>
<li><p>what is the type of <code>x[i]</code> and <code>y[i]</code>?</p></li>
<li><p>can I add these two types?</p></li>
<li><p>what is the type of <code>x[i] + y[i]</code> then?</p></li>
<li><p>can I store this result in <code>res</code> or do I need to convert it?</p></li>
</ul>
<p>These questions must be answered for each iteration, which takes time.<br />
Some of this is alleviated by JIT compilation.</p>
<p>On the contrary, for vectorized functions, these questions must be answered only once, which saves a lot of time.
Read more with <a href="http://www.noamross.net/blog/2014/4/16/vectorization-in-r--why.html">Noam Ross’s blog post on vectorization</a>.</p>
<div id="exercise-1" class="section level3 hasAnchor" number="5.3.1">
<h3><span class="header-section-number">5.3.1</span> Exercise<a href="performance.html#exercise-1" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>Monte-Carlo integration (example from <a href="https://bookdown.org/csgillespie/efficientR/programming.html#vectorised-code">book Efficient R programming</a>)</p>
<p>Suppose we wish to estimate the integral <span class="math inline">\(\int_0^1 x^2 dx\)</span> using a Monte-Carlo method. Essentially, we throw darts at the curve and count the number of darts that fall below the curve (as in the following figure).</p>
<p><img src="https://bookdown.org/csgillespie/efficientR/_main_files/figure-html/3-1-1.png" width="70%" style="display: block; margin: auto;" /></p>
<p><em>Monte Carlo Integration pseudo-code</em></p>
<ol style="list-style-type: decimal">
<li>Initialize: <code>hits = 0</code></li>
<li><strong>for i in 1:N</strong></li>
<li><span class="math inline">\(~~\)</span> Generate two random numbers, <span class="math inline">\(U_1\)</span> and <span class="math inline">\(U_2\)</span>, between 0 and 1</li>
<li><span class="math inline">\(~~\)</span> If <span class="math inline">\(U_2 &lt; U_1^2\)</span>, then <code>hits = hits + 1</code></li>
<li><strong>end for</strong></li>
<li>Area estimate = <code>hits / N</code></li>
</ol>
<p>Naively implementing this Monte-Carlo algorithm in R would typically lead to something like:</p>
<div class="sourceCode" id="cb398"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb398-1"><a href="performance.html#cb398-1" tabindex="-1"></a>monte_carlo <span class="ot">&lt;-</span> <span class="cf">function</span>(N) {</span>
<span id="cb398-2"><a href="performance.html#cb398-2" tabindex="-1"></a>  </span>
<span id="cb398-3"><a href="performance.html#cb398-3" tabindex="-1"></a>  hits <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb398-4"><a href="performance.html#cb398-4" tabindex="-1"></a>  <span class="cf">for</span> (i <span class="cf">in</span> <span class="fu">seq_len</span>(N)) {</span>
<span id="cb398-5"><a href="performance.html#cb398-5" tabindex="-1"></a>    u1 <span class="ot">&lt;-</span> <span class="fu">runif</span>(<span class="dv">1</span>)</span>
<span id="cb398-6"><a href="performance.html#cb398-6" tabindex="-1"></a>    u2 <span class="ot">&lt;-</span> <span class="fu">runif</span>(<span class="dv">1</span>)</span>
<span id="cb398-7"><a href="performance.html#cb398-7" tabindex="-1"></a>    <span class="cf">if</span> (u1 <span class="sc">^</span> <span class="dv">2</span> <span class="sc">&gt;</span> u2) {</span>
<span id="cb398-8"><a href="performance.html#cb398-8" tabindex="-1"></a>      hits <span class="ot">&lt;-</span> hits <span class="sc">+</span> <span class="dv">1</span></span>
<span id="cb398-9"><a href="performance.html#cb398-9" tabindex="-1"></a>    }</span>
<span id="cb398-10"><a href="performance.html#cb398-10" tabindex="-1"></a>  }</span>
<span id="cb398-11"><a href="performance.html#cb398-11" tabindex="-1"></a>  </span>
<span id="cb398-12"><a href="performance.html#cb398-12" tabindex="-1"></a>  hits <span class="sc">/</span> N</span>
<span id="cb398-13"><a href="performance.html#cb398-13" tabindex="-1"></a>}</span></code></pre></div>
<p>This takes a few seconds for <code>N = 1e6</code>:</p>
<div class="sourceCode" id="cb399"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb399-1"><a href="performance.html#cb399-1" tabindex="-1"></a>N <span class="ot">&lt;-</span> <span class="fl">1e6</span></span>
<span id="cb399-2"><a href="performance.html#cb399-2" tabindex="-1"></a><span class="fu">system.time</span>(<span class="fu">monte_carlo</span>(N))</span></code></pre></div>
<pre><code>#&gt;    user  system elapsed 
#&gt;    2.96    1.31    4.33</code></pre>
<p>Your task: find a vectorized solution for this problem:</p>
<div class="sourceCode" id="cb401"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb401-1"><a href="performance.html#cb401-1" tabindex="-1"></a><span class="fu">system.time</span>(<span class="fu">monte_carlo_vec</span>(N))</span></code></pre></div>
<pre><code>#&gt;    user  system elapsed 
#&gt;    0.06    0.00    0.06</code></pre>
</div>
</div>
<div id="Rcpp" class="section level2 hasAnchor" number="5.4">
<h2><span class="header-section-number">5.4</span> Rcpp<a href="performance.html#Rcpp" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>See <a href="https://privefl.github.io/R-presentation/Rcpp.html">this presentation</a>.</p>
<p>You have this data and this working code (a loop) that is slow</p>
<div class="sourceCode" id="cb403"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb403-1"><a href="performance.html#cb403-1" tabindex="-1"></a>mydf <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="fu">system.file</span>(<span class="st">&quot;extdata/one-million.rds&quot;</span>, <span class="at">package =</span> <span class="st">&quot;advr38pkg&quot;</span>))</span>
<span id="cb403-2"><a href="performance.html#cb403-2" tabindex="-1"></a></span>
<span id="cb403-3"><a href="performance.html#cb403-3" tabindex="-1"></a>QRA_3Dmatrix <span class="ot">&lt;-</span> <span class="fu">array</span>(<span class="dv">0</span>, <span class="at">dim =</span> <span class="fu">c</span>(<span class="fu">max</span>(mydf<span class="sc">$</span>ID), <span class="fu">max</span>(mydf<span class="sc">$</span>Volume), <span class="dv">2</span>))</span>
<span id="cb403-4"><a href="performance.html#cb403-4" tabindex="-1"></a></span>
<span id="cb403-5"><a href="performance.html#cb403-5" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="fu">seq_len</span>(<span class="fu">nrow</span>(mydf))) {</span>
<span id="cb403-6"><a href="performance.html#cb403-6" tabindex="-1"></a>  <span class="co"># Row corresponds to the ID class</span></span>
<span id="cb403-7"><a href="performance.html#cb403-7" tabindex="-1"></a>  row    <span class="ot">&lt;-</span> mydf<span class="sc">$</span>ID[i]</span>
<span id="cb403-8"><a href="performance.html#cb403-8" tabindex="-1"></a>  <span class="co"># Column corresponds to the volume class</span></span>
<span id="cb403-9"><a href="performance.html#cb403-9" tabindex="-1"></a>  column <span class="ot">&lt;-</span> mydf<span class="sc">$</span>Volume[i]</span>
<span id="cb403-10"><a href="performance.html#cb403-10" tabindex="-1"></a>  <span class="co"># Number of events, initially zero, then +1</span></span>
<span id="cb403-11"><a href="performance.html#cb403-11" tabindex="-1"></a>  QRA_3Dmatrix[row, column, <span class="dv">1</span>] <span class="ot">&lt;-</span> QRA_3Dmatrix[row, column, <span class="dv">1</span>] <span class="sc">+</span> <span class="dv">1</span>  </span>
<span id="cb403-12"><a href="performance.html#cb403-12" tabindex="-1"></a>  <span class="co"># Sum energy </span></span>
<span id="cb403-13"><a href="performance.html#cb403-13" tabindex="-1"></a>  QRA_3Dmatrix[row, column, <span class="dv">2</span>] <span class="ot">&lt;-</span> QRA_3Dmatrix[row, column, <span class="dv">2</span>] <span class="sc">+</span> </span>
<span id="cb403-14"><a href="performance.html#cb403-14" tabindex="-1"></a>    <span class="dv">1</span> <span class="sc">-</span> <span class="fl">1.358</span> <span class="sc">/</span> (<span class="dv">1</span> <span class="sc">+</span> <span class="fu">exp</span>( (<span class="dv">1000</span> <span class="sc">*</span> mydf<span class="sc">$</span>Energy[i] <span class="sc">-</span> <span class="dv">129000</span>) <span class="sc">/</span> <span class="dv">120300</span> ))</span>
<span id="cb403-15"><a href="performance.html#cb403-15" tabindex="-1"></a>}</span></code></pre></div>
<p>Rewrite this for-loop with Rcpp.</p>
<p>You can also try to use {dplyr} for this problem.</p>
</div>
<div id="linear-algebra" class="section level2 hasAnchor" number="5.5">
<h2><span class="header-section-number">5.5</span> Linear algebra<a href="performance.html#linear-algebra" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>In R, prefer using <code>crossprod(X)</code> and <code>tcrossprod(X)</code> instead of <code>t(X) %*% X</code> and <code>X %*% t(X)</code>. Also using <code>A %*% (B %*% y)</code> and <code>solve(A, y)</code> will be faster than <code>A %*% B %*% y</code> and <code>solve(A) %*% y</code>.</p>
<p>Don’t re-implement linear algebra operations (such as matrix products) yourself. There exist some highly optimized libraries for this. If you want to use linear algebra in Rcpp, try <a href="http://dirk.eddelbuettel.com/code/rcpp.armadillo.html">RcppArmadillo</a> or <a href="http://dirk.eddelbuettel.com/code/rcpp.eigen.html">RcppEigen</a>.</p>
<p>If you want to use some optimized multi-threaded linear library, you can try <a href="https://www.microsoft.com/en-US/download/details.aspx?id=51205">Microsoft R Open</a>.</p>
<div id="exercises-2" class="section level3 hasAnchor" number="5.5.1">
<h3><span class="header-section-number">5.5.1</span> Exercises<a href="performance.html#exercises-2" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>Compute the Euclidean distances between each of row of <code>X</code> and each row of <code>Y</code>:</p>
<div class="sourceCode" id="cb404"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb404-1"><a href="performance.html#cb404-1" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">1</span>)</span>
<span id="cb404-2"><a href="performance.html#cb404-2" tabindex="-1"></a>X <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="fu">rnorm</span>(<span class="dv">1000</span>), <span class="at">ncol =</span> <span class="dv">5</span>)</span>
<span id="cb404-3"><a href="performance.html#cb404-3" tabindex="-1"></a>Y <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="fu">rnorm</span>(<span class="dv">5000</span>), <span class="at">ncol =</span> <span class="dv">5</span>)</span></code></pre></div>
<p>A naive implementation would be:</p>
<div class="sourceCode" id="cb405"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb405-1"><a href="performance.html#cb405-1" tabindex="-1"></a><span class="fu">system.time</span>({</span>
<span id="cb405-2"><a href="performance.html#cb405-2" tabindex="-1"></a>  dist <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="cn">NA_real_</span>, <span class="fu">nrow</span>(X), <span class="fu">nrow</span>(Y))</span>
<span id="cb405-3"><a href="performance.html#cb405-3" tabindex="-1"></a>  <span class="cf">for</span> (i <span class="cf">in</span> <span class="fu">seq_len</span>(<span class="fu">nrow</span>(X))) {</span>
<span id="cb405-4"><a href="performance.html#cb405-4" tabindex="-1"></a>    <span class="cf">for</span> (j <span class="cf">in</span> <span class="fu">seq_len</span>(<span class="fu">nrow</span>(Y))) {</span>
<span id="cb405-5"><a href="performance.html#cb405-5" tabindex="-1"></a>      dist[i, j] <span class="ot">&lt;-</span> <span class="fu">sqrt</span>(<span class="fu">sum</span>((X[i, ] <span class="sc">-</span> Y[j, ])<span class="sc">^</span><span class="dv">2</span>))</span>
<span id="cb405-6"><a href="performance.html#cb405-6" tabindex="-1"></a>    }</span>
<span id="cb405-7"><a href="performance.html#cb405-7" tabindex="-1"></a>  }</span>
<span id="cb405-8"><a href="performance.html#cb405-8" tabindex="-1"></a>})</span></code></pre></div>
<pre><code>#&gt;    user  system elapsed 
#&gt;    0.22    0.03    0.25</code></pre>
<p>Try first to remove one of the two loops using <code>sweep()</code> instead. Then, try to implement a fully vectorized solution based on this hint: <span class="math inline">\(\text{dist}(X_i, Y_j)^2 = (X_i - Y_j)^T (X_i - Y_j) = X_i^T X_i + Y_j^T Y_j - 2 X_i^T Y_j\)</span>.</p>
<p>A faster possible solution takes</p>
<pre><code>#&gt;    user  system elapsed 
#&gt;       0       0       0</code></pre>
<!-- *** -->
<!-- Rewrite this problem to use linear algebra instead of a loop (Hint: resize the 3-dimensional arrays as 2D matrices): -->
<!-- ```{r} -->
<!-- N <- 1e5 -->
<!-- x <- rnorm(N*3*3);   dim(x) <- c(N,3,3) -->
<!-- y <- rnorm(N*3*3);   dim(y) <- c(N,3,3) -->
<!-- system.time({ -->
<!--   gg <- 0 -->
<!--   for (n in 1:dim(x)[1]){ -->
<!--     gg <- gg + t(x[n,,]) %*% y[n,,] -->
<!--   } -->
<!-- }) -->
<!-- ``` -->
<!-- A possible faster solution takes -->
<!-- ```{r, echo=FALSE} -->
<!-- system.time({ -->
<!--   dim(x) <- c(3 * N, 3) -->
<!--   dim(y) <- c(3 * N, 3) -->
<!--   gg2 <- crossprod(x, y) -->
<!-- }) -->
<!-- ``` -->
</div>
</div>
<div id="algorithms-data-structures" class="section level2 hasAnchor" number="5.6">
<h2><span class="header-section-number">5.6</span> Algorithms &amp; data structures<a href="performance.html#algorithms-data-structures" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>Sometimes, getting the right data structure (e.g. using a matrix instead of a data frame or integers instead of characters) can save you some computation time.</p>
<p>Is your algorithm doing some redundant computations making it e.g. quadratic instead of linear with respect to the dimension of your data?</p>
<p>See exercises (section <a href="performance.html#exos">5.7</a>) for some insights.</p>
<p>You can also find a detailed example in <a href="https://privefl.github.io/blog/performance-when-algorithmics-meets-mathematics/">this blog post</a>.</p>
</div>
<div id="exos" class="section level2 hasAnchor" number="5.7">
<h2><span class="header-section-number">5.7</span> Exercises<a href="performance.html#exos" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>Generate <span class="math inline">\(10^7\)</span> (start with <span class="math inline">\(10^5\)</span>) steps of the process described by the formula:<span class="math display">\[X(0)=0\]</span><span class="math display">\[X(t+1)=X(t)+Y(t)\]</span> where <span class="math inline">\(Y(t)\)</span> are independent random variables with the distribution <span class="math inline">\(N(0,1)\)</span>.
Then, calculate the percentage of <span class="math inline">\(X(t)\)</span> that are negative.
You do not need to store all values of <span class="math inline">\(X\)</span>.</p>
<p>A naive implementation with a for-loop could be:</p>
<div class="sourceCode" id="cb408"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb408-1"><a href="performance.html#cb408-1" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">1</span>)</span>
<span id="cb408-2"><a href="performance.html#cb408-2" tabindex="-1"></a></span>
<span id="cb408-3"><a href="performance.html#cb408-3" tabindex="-1"></a><span class="fu">system.time</span>({</span>
<span id="cb408-4"><a href="performance.html#cb408-4" tabindex="-1"></a>  N <span class="ot">&lt;-</span> <span class="fl">1e5</span></span>
<span id="cb408-5"><a href="performance.html#cb408-5" tabindex="-1"></a>  x <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb408-6"><a href="performance.html#cb408-6" tabindex="-1"></a>  count <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb408-7"><a href="performance.html#cb408-7" tabindex="-1"></a>  <span class="cf">for</span> (i <span class="cf">in</span> <span class="fu">seq_len</span>(N)) {</span>
<span id="cb408-8"><a href="performance.html#cb408-8" tabindex="-1"></a>    y <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(<span class="dv">1</span>)</span>
<span id="cb408-9"><a href="performance.html#cb408-9" tabindex="-1"></a>    x <span class="ot">&lt;-</span> x <span class="sc">+</span> y</span>
<span id="cb408-10"><a href="performance.html#cb408-10" tabindex="-1"></a>    <span class="cf">if</span> (x <span class="sc">&lt;</span> <span class="dv">0</span>) count <span class="ot">&lt;-</span> count <span class="sc">+</span> <span class="dv">1</span></span>
<span id="cb408-11"><a href="performance.html#cb408-11" tabindex="-1"></a>  }</span>
<span id="cb408-12"><a href="performance.html#cb408-12" tabindex="-1"></a>  p <span class="ot">&lt;-</span> count <span class="sc">/</span> N</span>
<span id="cb408-13"><a href="performance.html#cb408-13" tabindex="-1"></a>})</span></code></pre></div>
<pre><code>#&gt;    user  system elapsed 
#&gt;    0.19    0.06    0.25</code></pre>
<div class="sourceCode" id="cb410"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb410-1"><a href="performance.html#cb410-1" tabindex="-1"></a>p</span></code></pre></div>
<pre><code>#&gt; [1] 0.88454</code></pre>
<p>Try to vectorize this after having written the value of X(0), X(1), X(2), and X(3).
What would be the benefit of writing an Rcpp function over a simple vectorized R function?</p>
<div class="sourceCode" id="cb412"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb412-1"><a href="performance.html#cb412-1" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">1</span>)</span>
<span id="cb412-2"><a href="performance.html#cb412-2" tabindex="-1"></a><span class="fu">system.time</span>(p2 <span class="ot">&lt;-</span> advr38pkg<span class="sc">::</span><span class="fu">random_walk_neg_prop</span>(<span class="fl">1e5</span>))</span></code></pre></div>
<pre><code>#&gt;    user  system elapsed 
#&gt;    0.00    0.02    0.02</code></pre>
<div class="sourceCode" id="cb414"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb414-1"><a href="performance.html#cb414-1" tabindex="-1"></a>p2</span></code></pre></div>
<pre><code>#&gt; [1] 0.88454</code></pre>
<div class="sourceCode" id="cb416"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb416-1"><a href="performance.html#cb416-1" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">1</span>)</span>
<span id="cb416-2"><a href="performance.html#cb416-2" tabindex="-1"></a><span class="fu">system.time</span>(p3 <span class="ot">&lt;-</span> advr38pkg<span class="sc">::</span><span class="fu">random_walk_neg_prop</span>(<span class="fl">1e7</span>))</span></code></pre></div>
<pre><code>#&gt;    user  system elapsed 
#&gt;    0.40    0.00    0.41</code></pre>
<div class="sourceCode" id="cb418"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb418-1"><a href="performance.html#cb418-1" tabindex="-1"></a>p3</span></code></pre></div>
<pre><code>#&gt; [1] 0.3400444</code></pre>
<hr />
<div class="sourceCode" id="cb420"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb420-1"><a href="performance.html#cb420-1" tabindex="-1"></a>mat <span class="ot">&lt;-</span> <span class="fu">as.matrix</span>(mtcars)</span>
<span id="cb420-2"><a href="performance.html#cb420-2" tabindex="-1"></a>ind <span class="ot">&lt;-</span> <span class="fu">seq_len</span>(<span class="fu">nrow</span>(mat))</span>
<span id="cb420-3"><a href="performance.html#cb420-3" tabindex="-1"></a>mat_big <span class="ot">&lt;-</span> mat[<span class="fu">rep</span>(ind, <span class="dv">1000</span>), ]  <span class="do">## 1000 times bigger dataset</span></span>
<span id="cb420-4"><a href="performance.html#cb420-4" tabindex="-1"></a>last_row <span class="ot">&lt;-</span> mat_big[<span class="fu">nrow</span>(mat_big), ]</span></code></pre></div>
<p>Speed up these loops (vectorize):</p>
<div class="sourceCode" id="cb421"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb421-1"><a href="performance.html#cb421-1" tabindex="-1"></a><span class="fu">system.time</span>({</span>
<span id="cb421-2"><a href="performance.html#cb421-2" tabindex="-1"></a>  <span class="cf">for</span> (j <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">ncol</span>(mat_big)) {</span>
<span id="cb421-3"><a href="performance.html#cb421-3" tabindex="-1"></a>    <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(mat_big)) {</span>
<span id="cb421-4"><a href="performance.html#cb421-4" tabindex="-1"></a>      mat_big[i, j] <span class="ot">&lt;-</span> <span class="dv">10</span> <span class="sc">*</span> mat_big[i, j] <span class="sc">*</span> last_row[j]</span>
<span id="cb421-5"><a href="performance.html#cb421-5" tabindex="-1"></a>    }</span>
<span id="cb421-6"><a href="performance.html#cb421-6" tabindex="-1"></a>  }</span>
<span id="cb421-7"><a href="performance.html#cb421-7" tabindex="-1"></a>})</span></code></pre></div>
<pre><code>#&gt;    user  system elapsed 
#&gt;    0.42    0.00    0.43</code></pre>
<hr />
<p>Why <code>colSums()</code> on a whole matrix is faster than on only half of it?</p>
<div class="sourceCode" id="cb423"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb423-1"><a href="performance.html#cb423-1" tabindex="-1"></a>m0 <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="fu">rnorm</span>(<span class="fl">1e6</span>), <span class="fl">1e3</span>, <span class="fl">1e3</span>)</span>
<span id="cb423-2"><a href="performance.html#cb423-2" tabindex="-1"></a>microbenchmark<span class="sc">::</span><span class="fu">microbenchmark</span>(</span>
<span id="cb423-3"><a href="performance.html#cb423-3" tabindex="-1"></a>  <span class="fu">colSums</span>(m0[, <span class="dv">1</span><span class="sc">:</span><span class="dv">500</span>]), </span>
<span id="cb423-4"><a href="performance.html#cb423-4" tabindex="-1"></a>  <span class="fu">colSums</span>(m0)</span>
<span id="cb423-5"><a href="performance.html#cb423-5" tabindex="-1"></a>)</span></code></pre></div>
<pre><code>#&gt; Unit: microseconds
#&gt;                  expr    min      lq     mean  median      uq    max neval
#&gt;  colSums(m0[, 1:500]) 1739.1 1872.60 2178.074 1944.10 2108.10 7202.2   100
#&gt;           colSums(m0)  773.5  837.25  887.709  861.75  927.95 1226.3   100</code></pre>
<hr />
<p>Try to speed up this code by vectorizing it first, and/or by precomputing. Then, recode it in Rcpp and benchmark all the solutions you came up with.</p>
<div class="sourceCode" id="cb425"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb425-1"><a href="performance.html#cb425-1" tabindex="-1"></a>M <span class="ot">&lt;-</span> <span class="dv">50</span></span>
<span id="cb425-2"><a href="performance.html#cb425-2" tabindex="-1"></a>step1 <span class="ot">&lt;-</span> <span class="fu">runif</span>(M)</span>
<span id="cb425-3"><a href="performance.html#cb425-3" tabindex="-1"></a>A <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(M)</span>
<span id="cb425-4"><a href="performance.html#cb425-4" tabindex="-1"></a>N <span class="ot">&lt;-</span> <span class="fl">1e4</span></span>
<span id="cb425-5"><a href="performance.html#cb425-5" tabindex="-1"></a></span>
<span id="cb425-6"><a href="performance.html#cb425-6" tabindex="-1"></a>tau <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="dv">0</span>, N <span class="sc">+</span> <span class="dv">1</span>, M)</span>
<span id="cb425-7"><a href="performance.html#cb425-7" tabindex="-1"></a>tau[<span class="dv">1</span>, ] <span class="ot">&lt;-</span> A</span>
<span id="cb425-8"><a href="performance.html#cb425-8" tabindex="-1"></a><span class="cf">for</span> (j <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>M) {</span>
<span id="cb425-9"><a href="performance.html#cb425-9" tabindex="-1"></a>  <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">2</span><span class="sc">:</span><span class="fu">nrow</span>(tau)) {</span>
<span id="cb425-10"><a href="performance.html#cb425-10" tabindex="-1"></a>    tau[i, j] <span class="ot">&lt;-</span> tau[i <span class="sc">-</span> <span class="dv">1</span>, j] <span class="sc">+</span> step1[j] <span class="sc">*</span> <span class="fl">1.0025</span><span class="sc">^</span>(i <span class="sc">-</span> <span class="dv">2</span>)</span>
<span id="cb425-11"><a href="performance.html#cb425-11" tabindex="-1"></a>  }</span>
<span id="cb425-12"><a href="performance.html#cb425-12" tabindex="-1"></a>} </span></code></pre></div>
<hr />
<p>Make a fast function that counts the number of elements between a sequence of breaks. Can you do it in base R? Try also implementing it in Rcpp. How can you implement a solution whose computation time doesn’t depend on the number of breaks? [Which are the special cases that you should consider?]</p>
<div class="sourceCode" id="cb426"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb426-1"><a href="performance.html#cb426-1" tabindex="-1"></a>x <span class="ot">&lt;-</span> <span class="fu">sample</span>(<span class="dv">10</span>, <span class="at">size =</span> <span class="fl">1e4</span>, <span class="at">replace =</span> <span class="cn">TRUE</span>)</span>
<span id="cb426-2"><a href="performance.html#cb426-2" tabindex="-1"></a>breaks <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">3</span>, <span class="fl">8.5</span>, <span class="fl">9.5</span>, <span class="dv">10</span>)</span>
<span id="cb426-3"><a href="performance.html#cb426-3" tabindex="-1"></a><span class="fu">table</span>(<span class="fu">cut</span>(x, breaks), <span class="at">exclude =</span> <span class="cn">NULL</span>) <span class="co"># does not include first break (1)</span></span></code></pre></div>
<pre><code>#&gt; 
#&gt;     (1,3]   (3,8.5] (8.5,9.5]  (9.5,10]      &lt;NA&gt; 
#&gt;      2006      4970      1027       944      1053</code></pre>
<div class="sourceCode" id="cb428"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb428-1"><a href="performance.html#cb428-1" tabindex="-1"></a><span class="fu">hist</span>(x, breaks, <span class="at">plot =</span> <span class="cn">FALSE</span>)<span class="sc">$</span>counts  <span class="co"># includes first break</span></span></code></pre></div>
<pre><code>#&gt; [1] 3059 4970 1027  944</code></pre>
<div class="sourceCode" id="cb430"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb430-1"><a href="performance.html#cb430-1" tabindex="-1"></a>advr38pkg<span class="sc">::</span><span class="fu">count_by_breaks</span>(x, breaks)</span></code></pre></div>
<pre><code>#&gt; [1] 2006 4970 1027  944</code></pre>
<div class="sourceCode" id="cb432"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb432-1"><a href="performance.html#cb432-1" tabindex="-1"></a>advr38pkg<span class="sc">::</span><span class="fu">count_by_breaks_fast</span>(x, breaks)</span></code></pre></div>
<pre><code>#&gt; [1] 2006 4970 1027  944</code></pre>
<div class="sourceCode" id="cb434"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb434-1"><a href="performance.html#cb434-1" tabindex="-1"></a>microbenchmark<span class="sc">::</span><span class="fu">microbenchmark</span>(</span>
<span id="cb434-2"><a href="performance.html#cb434-2" tabindex="-1"></a>  <span class="fu">table</span>(<span class="fu">cut</span>(x, breaks)), </span>
<span id="cb434-3"><a href="performance.html#cb434-3" tabindex="-1"></a>  <span class="fu">hist</span>(x, breaks, <span class="at">plot =</span> <span class="cn">FALSE</span>)<span class="sc">$</span>counts, </span>
<span id="cb434-4"><a href="performance.html#cb434-4" tabindex="-1"></a>  advr38pkg<span class="sc">::</span><span class="fu">count_by_breaks</span>(x, breaks, <span class="at">use_outer =</span> <span class="cn">TRUE</span>),</span>
<span id="cb434-5"><a href="performance.html#cb434-5" tabindex="-1"></a>  advr38pkg<span class="sc">::</span><span class="fu">count_by_breaks</span>(x, breaks, <span class="at">use_outer =</span> <span class="cn">FALSE</span>),</span>
<span id="cb434-6"><a href="performance.html#cb434-6" tabindex="-1"></a>  advr38pkg<span class="sc">::</span><span class="fu">count_by_breaks_fast</span>(x, breaks)</span>
<span id="cb434-7"><a href="performance.html#cb434-7" tabindex="-1"></a>)</span></code></pre></div>
<pre><code>#&gt; Unit: microseconds
#&gt;                                                      expr   min     lq     mean median
#&gt;                                     table(cut(x, breaks)) 741.7 947.80 1238.794 995.20
#&gt;                      hist(x, breaks, plot = FALSE)$counts 379.3 414.20  468.615 445.55
#&gt;   advr38pkg::count_by_breaks(x, breaks, use_outer = TRUE) 374.0 480.70  527.305 493.10
#&gt;  advr38pkg::count_by_breaks(x, breaks, use_outer = FALSE) 207.1 232.95  256.590 242.85
#&gt;                advr38pkg::count_by_breaks_fast(x, breaks) 174.8 199.85  224.505 211.55
#&gt;       uq     max neval
#&gt;  1095.60 11724.5   100
#&gt;   492.55   838.7   100
#&gt;   544.15   897.2   100
#&gt;   271.75   384.1   100
#&gt;   238.20   388.9   100</code></pre>
<div class="sourceCode" id="cb436"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb436-1"><a href="performance.html#cb436-1" tabindex="-1"></a>x2 <span class="ot">&lt;-</span> <span class="fu">sample</span>(<span class="dv">100</span>, <span class="at">size =</span> <span class="fl">1e5</span>, <span class="at">replace =</span> <span class="cn">TRUE</span>)</span>
<span id="cb436-2"><a href="performance.html#cb436-2" tabindex="-1"></a>breaks2 <span class="ot">&lt;-</span> breaks <span class="sc">*</span> <span class="dv">10</span></span>
<span id="cb436-3"><a href="performance.html#cb436-3" tabindex="-1"></a>breaks3 <span class="ot">&lt;-</span> <span class="fu">seq</span>(<span class="dv">0</span>, <span class="dv">100</span>, <span class="at">length.out =</span> <span class="dv">100</span>)</span>
<span id="cb436-4"><a href="performance.html#cb436-4" tabindex="-1"></a>microbenchmark<span class="sc">::</span><span class="fu">microbenchmark</span>(</span>
<span id="cb436-5"><a href="performance.html#cb436-5" tabindex="-1"></a>  advr38pkg<span class="sc">::</span><span class="fu">count_by_breaks</span>(x2, breaks2),</span>
<span id="cb436-6"><a href="performance.html#cb436-6" tabindex="-1"></a>  advr38pkg<span class="sc">::</span><span class="fu">count_by_breaks_fast</span>(x2, breaks2),</span>
<span id="cb436-7"><a href="performance.html#cb436-7" tabindex="-1"></a>  advr38pkg<span class="sc">::</span><span class="fu">count_by_breaks</span>(x2, breaks3),</span>
<span id="cb436-8"><a href="performance.html#cb436-8" tabindex="-1"></a>  advr38pkg<span class="sc">::</span><span class="fu">count_by_breaks_fast</span>(x2, breaks3)</span>
<span id="cb436-9"><a href="performance.html#cb436-9" tabindex="-1"></a>)</span></code></pre></div>
<pre><code>#&gt; Unit: milliseconds
#&gt;                                          expr     min       lq      mean   median
#&gt;       advr38pkg::count_by_breaks(x2, breaks2)  1.3956  1.91115  2.011514  1.98715
#&gt;  advr38pkg::count_by_breaks_fast(x2, breaks2)  1.1257  1.53770  1.699999  1.61875
#&gt;       advr38pkg::count_by_breaks(x2, breaks3) 28.9796 40.35195 42.392982 41.15070
#&gt;  advr38pkg::count_by_breaks_fast(x2, breaks3)  1.1526  1.56035  1.873909  1.63580
#&gt;        uq     max neval
#&gt;   2.10990 10.3615   100
#&gt;   1.71825  9.5968   100
#&gt;  48.57445 54.6974   100
#&gt;   1.76560 10.0074   100</code></pre>
<hr />
<p>An R user wants to implement some sampling on a sparse matrix and provides this working code:</p>
<div class="sourceCode" id="cb438"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb438-1"><a href="performance.html#cb438-1" tabindex="-1"></a>N <span class="ot">&lt;-</span> <span class="dv">2000</span></span>
<span id="cb438-2"><a href="performance.html#cb438-2" tabindex="-1"></a><span class="fu">system.time</span>({</span>
<span id="cb438-3"><a href="performance.html#cb438-3" tabindex="-1"></a>  m <span class="ot">&lt;-</span> Matrix<span class="sc">::</span><span class="fu">Matrix</span>(<span class="dv">0</span>, <span class="at">nrow =</span> N, <span class="at">ncol =</span> N)</span>
<span id="cb438-4"><a href="performance.html#cb438-4" tabindex="-1"></a>  <span class="cf">for</span> (j <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>N) {</span>
<span id="cb438-5"><a href="performance.html#cb438-5" tabindex="-1"></a>    cols <span class="ot">&lt;-</span> <span class="fu">sample</span>((<span class="dv">1</span><span class="sc">:</span>N)[<span class="sc">-</span>j], <span class="dv">2</span>)  <span class="co"># pick 2 columns that are not j </span></span>
<span id="cb438-6"><a href="performance.html#cb438-6" tabindex="-1"></a>    m[j, cols] <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb438-7"><a href="performance.html#cb438-7" tabindex="-1"></a>  }</span>
<span id="cb438-8"><a href="performance.html#cb438-8" tabindex="-1"></a>})</span></code></pre></div>
<pre><code>#&gt;    user  system elapsed 
#&gt;    1.76    0.06    1.82</code></pre>
<p>This code is slow; can you find two major reasons why?</p>
<p>How can you more efficiently assign 1s? A faster solution would take:</p>
<pre><code>#&gt;    user  system elapsed 
#&gt;    0.05    0.03    0.08</code></pre>
<p>Can you use sampling with replacement (to avoid unnecessarily allocating memory) in this example? A faster solution would take:</p>
<pre><code>#&gt;    user  system elapsed 
#&gt;    0.01    0.00    0.02</code></pre>
<p>It would be even faster using Rcpp (cf. <a href="https://stackoverflow.com/a/45796424/6103040">this SO answer</a>).</p>
<hr />
<p>Make a fast function that returns all prime numbers up to a number <code>N</code>.</p>
<div class="sourceCode" id="cb442"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb442-1"><a href="performance.html#cb442-1" tabindex="-1"></a>N <span class="ot">&lt;-</span> <span class="fl">1e6</span></span>
<span id="cb442-2"><a href="performance.html#cb442-2" tabindex="-1"></a><span class="fu">system.time</span>(</span>
<span id="cb442-3"><a href="performance.html#cb442-3" tabindex="-1"></a>  primes <span class="ot">&lt;-</span> advr38pkg<span class="sc">::</span><span class="fu">AllPrimesUpTo</span>(N)</span>
<span id="cb442-4"><a href="performance.html#cb442-4" tabindex="-1"></a>)</span></code></pre></div>
<pre><code>#&gt;    user  system elapsed 
#&gt;    0.05    0.02    0.06</code></pre>
<div class="sourceCode" id="cb444"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb444-1"><a href="performance.html#cb444-1" tabindex="-1"></a><span class="fu">plot</span>(primes, <span class="at">pch =</span> <span class="dv">20</span>, <span class="at">cex =</span> <span class="fl">0.5</span>)</span></code></pre></div>
<p><img src="performance_files/figure-html/unnamed-chunk-55-1.png" width="70%" style="display: block; margin: auto;" /></p>
</div>
<div id="parallel-computing" class="section level2 hasAnchor" number="5.8">
<h2><span class="header-section-number">5.8</span> Parallel computing<a href="performance.html#parallel-computing" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>I basically always use <code>foreach</code> and recommend to do so. See <a href="https://privefl.github.io/blog/a-guide-to-parallelism-in-r/">my guide to parallelism in R with <code>foreach</code></a>.</p>
<p><strong>Just remember to optimize your code before trying to parallelize it.</strong></p>
<p>Try to parallelize some of your best solutions for the previous exercises.</p>

</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="tidyverse.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="packages.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": false,
"facebook": true,
"twitter": true,
"linkedin": false,
"weibo": false,
"instapaper": false,
"vk": false,
"whatsapp": false,
"all": ["facebook", "twitter", "linkedin", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": null,
"text": null
},
"history": {
"link": null,
"text": null
},
"view": {
"link": null,
"text": null
},
"download": null,
"search": {
"engine": "fuse",
"options": null
},
"toc": {
"collapse": "subsection"
}
});
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.9/latest.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>

</html>
