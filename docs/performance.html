<!DOCTYPE html>
<html >

<head>

  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title>Advanced R Course</title>
  <meta name="description" content="This contains materials for the Advanced R course of the doctoral school of Grenoble, France (2018).">
  <meta name="generator" content="bookdown 0.5 and GitBook 2.6.7">

  <meta property="og:title" content="Advanced R Course" />
  <meta property="og:type" content="book" />
  <meta property="og:url" content="https://privefl.github.io/advr38book/" />
  <meta property="og:image" content="https://privefl.github.io/advr38book/images/hexsticker.png" />
  <meta property="og:description" content="This contains materials for the Advanced R course of the doctoral school of Grenoble, France (2018)." />
  <meta name="github-repo" content="privefl/advr38book" />

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="Advanced R Course" />
  <meta name="twitter:site" content="@privefl" />
  <meta name="twitter:description" content="This contains materials for the Advanced R course of the doctoral school of Grenoble, France (2018)." />
  <meta name="twitter:image" content="https://privefl.github.io/advr38book/images/hexsticker.png" />

<meta name="author" content="Florian PrivÃ©">


<meta name="date" content="2018-02-19">

  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  
  
<link rel="prev" href="data-analysis-with-the-tidyverse.html">

<script src="libs/jquery-2.2.3/jquery.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />









<style type="text/css">
div.sourceCode { overflow-x: auto; }
table.sourceCode, tr.sourceCode, td.lineNumbers, td.sourceCode {
  margin: 0; padding: 0; vertical-align: baseline; border: none; }
table.sourceCode { width: 100%; line-height: 100%; }
td.lineNumbers { text-align: right; padding-right: 4px; padding-left: 4px; color: #aaaaaa; border-right: 1px solid #aaaaaa; }
td.sourceCode { padding-left: 5px; }
code > span.kw { color: #007020; font-weight: bold; } /* Keyword */
code > span.dt { color: #902000; } /* DataType */
code > span.dv { color: #40a070; } /* DecVal */
code > span.bn { color: #40a070; } /* BaseN */
code > span.fl { color: #40a070; } /* Float */
code > span.ch { color: #4070a0; } /* Char */
code > span.st { color: #4070a0; } /* String */
code > span.co { color: #60a0b0; font-style: italic; } /* Comment */
code > span.ot { color: #007020; } /* Other */
code > span.al { color: #ff0000; font-weight: bold; } /* Alert */
code > span.fu { color: #06287e; } /* Function */
code > span.er { color: #ff0000; font-weight: bold; } /* Error */
code > span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
code > span.cn { color: #880000; } /* Constant */
code > span.sc { color: #4070a0; } /* SpecialChar */
code > span.vs { color: #4070a0; } /* VerbatimString */
code > span.ss { color: #bb6688; } /* SpecialString */
code > span.im { } /* Import */
code > span.va { color: #19177c; } /* Variable */
code > span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code > span.op { color: #666666; } /* Operator */
code > span.bu { } /* BuiltIn */
code > span.ex { } /* Extension */
code > span.pp { color: #bc7a00; } /* Preprocessor */
code > span.at { color: #7d9029; } /* Attribute */
code > span.do { color: #ba2121; font-style: italic; } /* Documentation */
code > span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code > span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code > span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
</style>

<link rel="stylesheet" href="style.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li><a href="./index.html">Advanced R Course [WORK IN PROGRESS]</a></li>

<li class="divider"></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i>About</a><ul>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#license"><i class="fa fa-check"></i>License</a></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#author"><i class="fa fa-check"></i>Author</a></li>
</ul></li>
<li class="chapter" data-level="1" data-path="introduction.html"><a href="introduction.html"><i class="fa fa-check"></i><b>1</b> Introduction</a><ul>
<li class="chapter" data-level="1.1" data-path="introduction.html"><a href="introduction.html#prerequisites"><i class="fa fa-check"></i><b>1.1</b> Prerequisites</a></li>
<li class="chapter" data-level="1.2" data-path="introduction.html"><a href="introduction.html#content"><i class="fa fa-check"></i><b>1.2</b> Content</a></li>
<li class="chapter" data-level="1.3" data-path="introduction.html"><a href="introduction.html#useful-resources"><i class="fa fa-check"></i><b>1.3</b> Useful resources</a></li>
</ul></li>
<li class="chapter" data-level="2" data-path="good-practices.html"><a href="good-practices.html"><i class="fa fa-check"></i><b>2</b> Good practices</a><ul>
<li class="chapter" data-level="2.1" data-path="good-practices.html"><a href="good-practices.html#coding-style"><i class="fa fa-check"></i><b>2.1</b> Coding style</a><ul>
<li class="chapter" data-level="2.1.1" data-path="good-practices.html"><a href="good-practices.html#spacing"><i class="fa fa-check"></i><b>2.1.1</b> Spacing</a></li>
<li class="chapter" data-level="2.1.2" data-path="good-practices.html"><a href="good-practices.html#indenting"><i class="fa fa-check"></i><b>2.1.2</b> Indenting</a></li>
<li class="chapter" data-level="2.1.3" data-path="good-practices.html"><a href="good-practices.html#long-lines"><i class="fa fa-check"></i><b>2.1.3</b> Long lines</a></li>
<li class="chapter" data-level="2.1.4" data-path="good-practices.html"><a href="good-practices.html#other"><i class="fa fa-check"></i><b>2.1.4</b> Other</a></li>
</ul></li>
<li class="chapter" data-level="2.2" data-path="good-practices.html"><a href="good-practices.html#rstudio"><i class="fa fa-check"></i><b>2.2</b> RStudio</a></li>
<li class="chapter" data-level="2.3" data-path="good-practices.html"><a href="good-practices.html#version-control-git"><i class="fa fa-check"></i><b>2.3</b> Version control (Git)</a><ul>
<li class="chapter" data-level="2.3.1" data-path="good-practices.html"><a href="good-practices.html#why-use-git"><i class="fa fa-check"></i><b>2.3.1</b> Why use Git?</a></li>
<li class="chapter" data-level="2.3.2" data-path="good-practices.html"><a href="good-practices.html#git"><i class="fa fa-check"></i><b>2.3.2</b> Git</a></li>
</ul></li>
<li class="chapter" data-level="2.4" data-path="good-practices.html"><a href="good-practices.html#getting-help"><i class="fa fa-check"></i><b>2.4</b> Getting help</a><ul>
<li class="chapter" data-level="2.4.1" data-path="good-practices.html"><a href="good-practices.html#help-yourself-learn-how-to-debug"><i class="fa fa-check"></i><b>2.4.1</b> Help yourself, learn how to debug</a></li>
<li class="chapter" data-level="2.4.2" data-path="good-practices.html"><a href="good-practices.html#external-help"><i class="fa fa-check"></i><b>2.4.2</b> External help</a></li>
<li class="chapter" data-level="2.4.3" data-path="good-practices.html"><a href="good-practices.html#exercises"><i class="fa fa-check"></i><b>2.4.3</b> Exercises</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="3" data-path="r-programming.html"><a href="r-programming.html"><i class="fa fa-check"></i><b>3</b> R programming</a><ul>
<li class="chapter" data-level="3.1" data-path="r-programming.html"><a href="r-programming.html#common-mistakes"><i class="fa fa-check"></i><b>3.1</b> Common mistakes</a><ul>
<li class="chapter" data-level="3.1.1" data-path="r-programming.html"><a href="r-programming.html#equality"><i class="fa fa-check"></i><b>3.1.1</b> Equality</a></li>
<li class="chapter" data-level="3.1.2" data-path="r-programming.html"><a href="r-programming.html#arguments"><i class="fa fa-check"></i><b>3.1.2</b> Arguments</a></li>
<li class="chapter" data-level="3.1.3" data-path="r-programming.html"><a href="r-programming.html#others"><i class="fa fa-check"></i><b>3.1.3</b> Others</a></li>
</ul></li>
<li class="chapter" data-level="3.2" data-path="r-programming.html"><a href="r-programming.html#r-base-objects"><i class="fa fa-check"></i><b>3.2</b> R base objects</a><ul>
<li class="chapter" data-level="3.2.1" data-path="r-programming.html"><a href="r-programming.html#types"><i class="fa fa-check"></i><b>3.2.1</b> Types</a></li>
<li class="chapter" data-level="3.2.2" data-path="r-programming.html"><a href="r-programming.html#exercise"><i class="fa fa-check"></i><b>3.2.2</b> Exercise</a></li>
</ul></li>
<li class="chapter" data-level="3.3" data-path="r-programming.html"><a href="r-programming.html#base-objects-and-accessors"><i class="fa fa-check"></i><b>3.3</b> Base objects and accessors</a><ul>
<li class="chapter" data-level="3.3.1" data-path="r-programming.html"><a href="r-programming.html#objects"><i class="fa fa-check"></i><b>3.3.1</b> Objects</a></li>
<li class="chapter" data-level="3.3.2" data-path="r-programming.html"><a href="r-programming.html#accessors"><i class="fa fa-check"></i><b>3.3.2</b> Accessors</a></li>
<li class="chapter" data-level="3.3.3" data-path="r-programming.html"><a href="r-programming.html#exercises-1"><i class="fa fa-check"></i><b>3.3.3</b> Exercises</a></li>
</ul></li>
<li class="chapter" data-level="3.4" data-path="r-programming.html"><a href="r-programming.html#useful-r-base-functions"><i class="fa fa-check"></i><b>3.4</b> Useful R base functions</a><ul>
<li class="chapter" data-level="3.4.1" data-path="r-programming.html"><a href="r-programming.html#general"><i class="fa fa-check"></i><b>3.4.1</b> General</a></li>
<li class="chapter" data-level="3.4.2" data-path="r-programming.html"><a href="r-programming.html#sequence-and-vector-operations"><i class="fa fa-check"></i><b>3.4.2</b> Sequence and vector operations</a></li>
<li class="chapter" data-level="3.4.3" data-path="r-programming.html"><a href="r-programming.html#character-operations"><i class="fa fa-check"></i><b>3.4.3</b> Character operations</a></li>
<li class="chapter" data-level="3.4.4" data-path="r-programming.html"><a href="r-programming.html#logical-operators"><i class="fa fa-check"></i><b>3.4.4</b> Logical operators</a></li>
<li class="chapter" data-level="3.4.5" data-path="r-programming.html"><a href="r-programming.html#exercises-2"><i class="fa fa-check"></i><b>3.4.5</b> Exercises</a></li>
</ul></li>
<li class="chapter" data-level="3.5" data-path="r-programming.html"><a href="r-programming.html#environments-and-scoping"><i class="fa fa-check"></i><b>3.5</b> Environments and scoping</a></li>
<li class="chapter" data-level="3.6" data-path="r-programming.html"><a href="r-programming.html#attributes-and-classes"><i class="fa fa-check"></i><b>3.6</b> Attributes and classes</a></li>
</ul></li>
<li class="chapter" data-level="4" data-path="data-analysis-with-the-tidyverse.html"><a href="data-analysis-with-the-tidyverse.html"><i class="fa fa-check"></i><b>4</b> Data analysis with the tidyverse</a></li>
<li class="chapter" data-level="5" data-path="performance.html"><a href="performance.html"><i class="fa fa-check"></i><b>5</b> Performance</a><ul>
<li class="chapter" data-level="5.1" data-path="performance.html"><a href="performance.html#common-mistakes-and-solutions"><i class="fa fa-check"></i><b>5.1</b> Common mistakes and solutions</a><ul>
<li class="chapter" data-level="5.1.1" data-path="performance.html"><a href="performance.html#growing-an-object"><i class="fa fa-check"></i><b>5.1.1</b> Growing an object</a></li>
<li class="chapter" data-level="5.1.2" data-path="performance.html"><a href="performance.html#trying-to-optimize-everything"><i class="fa fa-check"></i><b>5.1.2</b> Trying to optimize everything</a></li>
<li class="chapter" data-level="5.1.3" data-path="performance.html"><a href="performance.html#exercise-1"><i class="fa fa-check"></i><b>5.1.3</b> Exercise</a></li>
</ul></li>
<li class="chapter" data-level="5.2" data-path="performance.html"><a href="performance.html#vectorization"><i class="fa fa-check"></i><b>5.2</b> Vectorization</a><ul>
<li class="chapter" data-level="5.2.1" data-path="performance.html"><a href="performance.html#exercises-3"><i class="fa fa-check"></i><b>5.2.1</b> Exercises</a></li>
</ul></li>
<li class="chapter" data-level="5.3" data-path="performance.html"><a href="performance.html#linear-algebra"><i class="fa fa-check"></i><b>5.3</b> Linear algebra</a></li>
</ul></li>
<li class="divider"></li>
<li><a href="https://github.com/rstudio/bookdown" target="blank">Published with bookdown</a></li>
</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">Advanced R Course</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="performance" class="section level1">
<h1><span class="header-section-number">Chapter 5</span> Performance</h1>
<p>The people who say that R is just always slow usually are not great R programmers. It is true that writing inefficient R code is easy, yet writing efficient R code is also possible when you know what youâre doing. In this chapter, you will learn how to write R(cpp) code that is fast.</p>
<p>Some years ago, when introducing the Julia language, some really unfair benchmark comparisons were released (e.g.Â with loops where obvious and simpler vectorized code would have been much faster). Iâm still mad at Julia for this and <a href="https://matloff.wordpress.com/2014/05/21/r-beats-python-r-beats-julia-anyone-else-wanna-challenge-r/">I am not the only one</a>.</p>
<div id="common-mistakes-and-solutions" class="section level2">
<h2><span class="header-section-number">5.1</span> Common mistakes and solutions</h2>
<div id="growing-an-object" class="section level3">
<h3><span class="header-section-number">5.1.1</span> Growing an object</h3>
<p><strong>NEVER GROW AN OBJECT</strong></p>
<p>Example computing the cumulative sums of a vector:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">x &lt;-<span class="st"> </span><span class="kw">rnorm</span>(<span class="fl">1e4</span>)  <span class="co"># Try also with n = 1e5</span>
<span class="kw">system.time</span>({
  current_sum &lt;-<span class="st"> </span><span class="dv">0</span>
  res &lt;-<span class="st"> </span><span class="kw">c</span>()
  for (x_i in x) {
    current_sum &lt;-<span class="st"> </span>current_sum +<span class="st"> </span>x_i
    res &lt;-<span class="st"> </span><span class="kw">c</span>(res, current_sum)
  }
})</code></pre></div>
<pre><code>#&gt;    user  system elapsed 
#&gt;   0.163   0.002   0.164</code></pre>
<p>Here, at each iterating, you reallocating a vector (of increasing size). It makes your computation quadratic with the size of <code>x</code> (if you multiply the size by 2, you can expect the execution time to be multiplied by 4, for large sample sizes), whereas it should be only linear. Indeed, we will see that execution time can be composed of computation time but also allocation time.</p>
<p>A good solution is to always pre-allocating your results (if you know the size):</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">system.time</span>({
  current_sum &lt;-<span class="st"> </span><span class="dv">0</span>
  res2 &lt;-<span class="st"> </span><span class="kw">double</span>(<span class="kw">length</span>(x))
  for (i in <span class="kw">seq_along</span>(x)) {
    current_sum &lt;-<span class="st"> </span>current_sum +<span class="st"> </span>x[i]
    res2[i] &lt;-<span class="st"> </span>current_sum
  }
})</code></pre></div>
<pre><code>#&gt;    user  system elapsed 
#&gt;   0.006   0.000   0.006</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">all.equal</span>(res2, res)</code></pre></div>
<pre><code>#&gt; [1] TRUE</code></pre>
<p>An even better solution would be to avoid the loop by using a vectorized function:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">system.time</span>(res3 &lt;-<span class="st"> </span><span class="kw">cumsum</span>(x))</code></pre></div>
<pre><code>#&gt;    user  system elapsed 
#&gt;       0       0       0</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">all.equal</span>(res3, res)</code></pre></div>
<pre><code>#&gt; [1] TRUE</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">x &lt;-<span class="st"> </span><span class="kw">rnorm</span>(<span class="fl">1e7</span>)
<span class="kw">system.time</span>(<span class="kw">cumsum</span>(x))</code></pre></div>
<pre><code>#&gt;    user  system elapsed 
#&gt;   0.044   0.006   0.052</code></pre>
<p>As a second example, let us generate a matrix of uniform values (max changing for every column):</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">n &lt;-<span class="st"> </span><span class="fl">1e3</span>
max &lt;-<span class="st"> </span><span class="dv">1</span>:<span class="dv">1000</span>
<span class="kw">system.time</span>({
  mat &lt;-<span class="st"> </span><span class="ot">NULL</span>
  for (m in max) {
    mat &lt;-<span class="st"> </span><span class="kw">cbind</span>(mat, <span class="kw">runif</span>(n, <span class="dt">max =</span> m))
  }
})</code></pre></div>
<pre><code>#&gt;    user  system elapsed 
#&gt;   0.601   0.229   0.830</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">apply</span>(mat, <span class="dv">2</span>, max)[<span class="dv">1</span>:<span class="dv">10</span>]</code></pre></div>
<pre><code>#&gt;  [1] 0.999764 1.999654 2.994555 3.996506 4.999664 5.986646 6.994761
#&gt;  [8] 7.993455 8.989736 9.984301</code></pre>
<p>So, we can either pre-allocate a list or a matrix:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">system.time</span>({
  l &lt;-<span class="st"> </span><span class="kw">vector</span>(<span class="st">&quot;list&quot;</span>, <span class="kw">length</span>(max))
  for (i in <span class="kw">seq_along</span>(max)) {
    l[[i]] &lt;-<span class="st"> </span><span class="kw">runif</span>(n, <span class="dt">max =</span> max[i])
  }
  mat2 &lt;-<span class="st"> </span><span class="kw">do.call</span>(<span class="st">&quot;cbind&quot;</span>, l)
})</code></pre></div>
<pre><code>#&gt;    user  system elapsed 
#&gt;   0.032   0.001   0.033</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">apply</span>(mat2, <span class="dv">2</span>, max)[<span class="dv">1</span>:<span class="dv">10</span>]</code></pre></div>
<pre><code>#&gt;  [1] 0.9993215 1.9986477 2.9999922 3.9933047 4.9984811 5.9915939 6.9848479
#&gt;  [8] 7.9998921 8.9958427 9.9946621</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">system.time</span>({
  mat3 &lt;-<span class="st"> </span><span class="kw">matrix</span>(<span class="dv">0</span>, n, <span class="kw">length</span>(max))
  for (i in <span class="kw">seq_along</span>(max)) {
    mat3[, i] &lt;-<span class="st"> </span><span class="kw">runif</span>(n, <span class="dt">max =</span> max[i])
  }
})</code></pre></div>
<pre><code>#&gt;    user  system elapsed 
#&gt;   0.034   0.000   0.035</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">apply</span>(mat3, <span class="dv">2</span>, max)[<span class="dv">1</span>:<span class="dv">10</span>]</code></pre></div>
<pre><code>#&gt;  [1] 0.9981747 1.9998035 2.9956297 3.9946061 4.9952660 5.9918817 6.9939379
#&gt;  [8] 7.9997888 8.9865920 9.9924091</code></pre>
<p>Instead of pre-allocating yourself, you can use <code>sapply</code> (or <code>lapply</code> and calling <code>do.call()</code> after, as previously done):</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">system.time</span>(
  mat4 &lt;-<span class="st"> </span><span class="kw">sapply</span>(max, function(m) <span class="kw">runif</span>(n, <span class="dt">max =</span> m))
)</code></pre></div>
<pre><code>#&gt;    user  system elapsed 
#&gt;   0.033   0.000   0.034</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">apply</span>(mat4, <span class="dv">2</span>, max)[<span class="dv">1</span>:<span class="dv">10</span>]</code></pre></div>
<pre><code>#&gt;  [1] 0.9999645 1.9981928 2.9993311 3.9993598 4.9934163 5.9983745 6.9985639
#&gt;  [8] 7.9883881 8.9877855 9.9981783</code></pre>
</div>
<div id="trying-to-optimize-everything" class="section level3">
<h3><span class="header-section-number">5.1.2</span> Trying to optimize everything</h3>
<p>If you try to optimize each and every part of your code, you will end up losing a lot of time writing it and it will probably less readable.</p>
<p>R is great to prototyping quickly because you can write code in a concise and easy way. Begin by doing just that. If performance matters, then profile your code to see which part of your code is taking too much time and optimize only this part!</p>
<p>Learn more on how to profile your code in RStudio in <a href="https://support.rstudio.com/hc/en-us/articles/218221837-Profiling-with-RStudio">this article</a>.</p>
</div>
<div id="exercise-1" class="section level3">
<h3><span class="header-section-number">5.1.3</span> Exercise</h3>
<p>TODO</p>
</div>
</div>
<div id="vectorization" class="section level2">
<h2><span class="header-section-number">5.2</span> Vectorization</h2>
<p>See <a href="http://www.noamross.net/blog/2014/4/16/vectorization-in-r--why.html">this great blog post by Noam Ross</a> to understand vectorization.</p>
<div id="exercises-3" class="section level3">
<h3><span class="header-section-number">5.2.1</span> Exercises</h3>
<p>Monte-Carlo integration (example from <a href="https://bookdown.org/csgillespie/efficientR/programming.html#vectorised-code">book Efficient R programming</a>)</p>
<p>Suppose we wish to estimate the integral <span class="math inline">\(\int_0^1 x^2 dx\)</span> using a Monte-Carlo method. Essentially, we throw darts at the curve and count the number of darts that fall below the curve (as in the following figure).</p>
<p><img src="https://bookdown.org/csgillespie/efficientR/_main_files/figure-html/3-1-1.png" width="70%" style="display: block; margin: auto;" /></p>
<p><em>Monte Carlo Integration pseudo-code</em></p>
<ol style="list-style-type: decimal">
<li>Initialize: <code>hits = 0</code></li>
<li><strong>for i in 1:N</strong></li>
<li><span class="math inline">\(~~\)</span> Generate two random numbers, <span class="math inline">\(U_1\)</span> and <span class="math inline">\(U_2\)</span>, between 0 and 1</li>
<li><span class="math inline">\(~~\)</span> If <span class="math inline">\(U_2 &lt; U_1^2\)</span>, then <code>hits = hits + 1</code></li>
<li><strong>end for</strong></li>
<li>Area estimate = <code>hits/N</code></li>
</ol>
<p>Naively implementing this Monte-Carlo algorithm in R would typically lead to something like:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">monte_carlo &lt;-<span class="st"> </span>function(N) {
  
  hits &lt;-<span class="st"> </span><span class="dv">0</span>
  for (i in <span class="kw">seq_len</span>(N)) {
    u1 &lt;-<span class="st"> </span><span class="kw">runif</span>(<span class="dv">1</span>)
    u2 &lt;-<span class="st"> </span><span class="kw">runif</span>(<span class="dv">1</span>)
    if (u1 ^<span class="st"> </span><span class="dv">2</span> &gt;<span class="st"> </span>u2) {
      hits &lt;-<span class="st"> </span>hits +<span class="st"> </span><span class="dv">1</span>
    }
  }
  
  hits /<span class="st"> </span>N
}</code></pre></div>
<p>This takes a few seconds for <code>N = 1e6</code>:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">N &lt;-<span class="st"> </span><span class="fl">1e6</span>
<span class="kw">system.time</span>(<span class="kw">monte_carlo</span>(N))</code></pre></div>
<pre><code>#&gt;    user  system elapsed 
#&gt;   2.558   0.006   2.564</code></pre>
<p><strong>Your task: Find a vectorized solution for this problem:</strong></p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">system.time</span>(<span class="kw">monte_carlo_vec</span>(N))</code></pre></div>
<pre><code>#&gt;    user  system elapsed 
#&gt;   0.061   0.000   0.061</code></pre>
<hr />
<p>TODO smoothing on data points</p>
</div>
</div>
<div id="linear-algebra" class="section level2">
<h2><span class="header-section-number">5.3</span> Linear algebra</h2>
<p>In R, prefer using <code>crossprod(X)</code> and <code>tcrossprod(X)</code> instead of <code>t(X) %*% X</code> and <code>X %*% t(X)</code>. Also using <code>A %*% (B %*% y)</code> and <code>solve(A, y)</code> will be faster than <code>A %*% B %*% y</code> and <code>solve(A) %*% y</code>.</p>
<p>Donât re-implement linear algebra such as matrix products yourself. There exists some highly optimized libraries for this. If you want to use linear algebra in Rcpp, try <a href="http://dirk.eddelbuettel.com/code/rcpp.armadillo.html">RcppArmadillo</a> or <a href="http://dirk.eddelbuettel.com/code/rcpp.eigen.html">RcppEigen</a>.</p>
<p>If you want to use some optimized multi-threaded linear library, install <a href="https://mran.revolutionanalytics.com/documents/rro/multithread">Microsoft R Open</a>.</p>

</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="data-analysis-with-the-tidyverse.html" class="navigation navigation-prev navigation-unique" aria-label="Previous page"><i class="fa fa-angle-left"></i></a>

    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/lunr.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": false,
"facebook": true,
"twitter": true,
"google": false,
"weibo": false,
"instapper": false,
"vk": false,
"all": ["facebook", "google", "twitter", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": "https://github.com/privefl/advr38book/edit/master/performance.Rmd",
"text": "Edit"
},
"download": null,
"toc": {
"collapse": "subsection"
}
});
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://cdn.bootcss.com/mathjax/2.7.1/MathJax.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:" && /^https?:/.test(script.src))
      script.src  = script.src.replace(/^https?:/, '');
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>

</html>
